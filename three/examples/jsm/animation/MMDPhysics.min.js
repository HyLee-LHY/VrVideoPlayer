/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/three@0.117.1/examples/jsm/animation/MMDPhysics.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{Bone,BoxBufferGeometry,Color,CylinderBufferGeometry,Euler,Matrix4,Mesh,MeshBasicMaterial,Object3D,Quaternion,SphereBufferGeometry,Vector3}from"../../../build/three.module.js";var MMDPhysics=function(){function t(t,r,i,o){if("undefined"==typeof Ammo)throw new Error("THREE.MMDPhysics: Import ammo.js https://github.com/kripken/ammo.js");i=i||[],o=o||{},this.manager=new e,this.mesh=t,this.unitStep=void 0!==o.unitStep?o.unitStep:1/65,this.maxStepNum=void 0!==o.maxStepNum?o.maxStepNum:3,this.gravity=new Vector3(0,-98,0),void 0!==o.gravity&&this.gravity.copy(o.gravity),this.world=void 0!==o.world?o.world:null,this.bodies=[],this.constraints=[],this._init(t,r,i)}function e(){this.threeVector3s=[],this.threeMatrix4s=[],this.threeQuaternions=[],this.threeEulers=[],this.transforms=[],this.quaternions=[],this.vector3s=[]}function r(t,e,r,i){this.mesh=t,this.world=e,this.params=r,this.manager=i,this.body=null,this.bone=null,this.boneOffsetForm=null,this.boneOffsetFormInverse=null,this._init()}function i(t,e,r,i,o,s){this.mesh=t,this.world=e,this.bodyA=r,this.bodyB=i,this.params=o,this.manager=s,this.constraint=null,this._init()}function o(t,e){Object3D.call(this),this.root=t,this.physics=e,this.matrix.copy(t.matrixWorld),this.matrixAutoUpdate=!1,this.materials=[],this.materials.push(new MeshBasicMaterial({color:new Color(16746632),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new MeshBasicMaterial({color:new Color(8978312),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new MeshBasicMaterial({color:new Color(8947967),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this._init()}var s,n,a,h;return t.prototype={constructor:t,update:function(t){var e,r=this.manager,i=this.mesh,o=!1,s=r.allocThreeVector3(),n=r.allocThreeQuaternion(),a=r.allocThreeVector3();return i.matrixWorld.decompose(s,n,a),1===a.x&&1===a.y&&1===a.z||(o=!0),o&&(null!==(e=i.parent)&&(i.parent=null),a.copy(this.mesh.scale),i.scale.set(1,1,1),i.updateMatrixWorld(!0)),this._updateRigidBodies(),this._stepSimulation(t),this._updateBones(),o&&(null!==e&&(i.parent=e),i.scale.copy(a)),r.freeThreeVector3(a),r.freeThreeQuaternion(n),r.freeThreeVector3(s),this},reset:function(){for(var t=0,e=this.bodies.length;t<e;t++)this.bodies[t].reset();return this},warmup:function(t){for(var e=0;e<t;e++)this.update(1/60);return this},setGravity:function(t){return this.world.setGravity(new Ammo.btVector3(t.x,t.y,t.z)),this.gravity.copy(t),this},createHelper:function(){return new o(this.mesh,this)},_init:function(t,e,r){var i=this.manager,o=t.parent;null!==o&&(o=null);var s=i.allocThreeVector3(),n=i.allocThreeQuaternion(),a=i.allocThreeVector3();s.copy(t.position),n.copy(t.quaternion),a.copy(t.scale),t.position.set(0,0,0),t.quaternion.set(0,0,0,1),t.scale.set(1,1,1),t.updateMatrixWorld(!0),null===this.world&&(this.world=this._createWorld(),this.setGravity(this.gravity)),this._initRigidBodies(e),this._initConstraints(r),null!==o&&(t.parent=o),t.position.copy(s),t.quaternion.copy(n),t.scale.copy(a),t.updateMatrixWorld(!0),this.reset(),i.freeThreeVector3(s),i.freeThreeQuaternion(n),i.freeThreeVector3(a)},_createWorld:function(){var t=new Ammo.btDefaultCollisionConfiguration,e=new Ammo.btCollisionDispatcher(t),r=new Ammo.btDbvtBroadphase,i=new Ammo.btSequentialImpulseConstraintSolver;return new Ammo.btDiscreteDynamicsWorld(e,r,i,t)},_initRigidBodies:function(t){for(var e=0,i=t.length;e<i;e++)this.bodies.push(new r(this.mesh,this.world,t[e],this.manager))},_initConstraints:function(t){for(var e=0,r=t.length;e<r;e++){var o=t[e],s=this.bodies[o.rigidBodyIndex1],n=this.bodies[o.rigidBodyIndex2];this.constraints.push(new i(this.mesh,this.world,s,n,o,this.manager))}},_stepSimulation:function(t){var e=this.unitStep,r=t,i=1+(t/e|0);r<e&&(r=e,i=1),i>this.maxStepNum&&(i=this.maxStepNum),this.world.stepSimulation(r,i,e)},_updateRigidBodies:function(){for(var t=0,e=this.bodies.length;t<e;t++)this.bodies[t].updateFromBone()},_updateBones:function(){for(var t=0,e=this.bodies.length;t<e;t++)this.bodies[t].updateBone()}},e.prototype={constructor:e,allocThreeVector3:function(){return this.threeVector3s.length>0?this.threeVector3s.pop():new Vector3},freeThreeVector3:function(t){this.threeVector3s.push(t)},allocThreeMatrix4:function(){return this.threeMatrix4s.length>0?this.threeMatrix4s.pop():new Matrix4},freeThreeMatrix4:function(t){this.threeMatrix4s.push(t)},allocThreeQuaternion:function(){return this.threeQuaternions.length>0?this.threeQuaternions.pop():new Quaternion},freeThreeQuaternion:function(t){this.threeQuaternions.push(t)},allocThreeEuler:function(){return this.threeEulers.length>0?this.threeEulers.pop():new Euler},freeThreeEuler:function(t){this.threeEulers.push(t)},allocTransform:function(){return this.transforms.length>0?this.transforms.pop():new Ammo.btTransform},freeTransform:function(t){this.transforms.push(t)},allocQuaternion:function(){return this.quaternions.length>0?this.quaternions.pop():new Ammo.btQuaternion},freeQuaternion:function(t){this.quaternions.push(t)},allocVector3:function(){return this.vector3s.length>0?this.vector3s.pop():new Ammo.btVector3},freeVector3:function(t){this.vector3s.push(t)},setIdentity:function(t){t.setIdentity()},getBasis:function(t){var e=this.allocQuaternion();return t.getBasis().getRotation(e),e},getBasisAsMatrix3:function(t){var e=this.getBasis(t),r=this.quaternionToMatrix3(e);return this.freeQuaternion(e),r},getOrigin:function(t){return t.getOrigin()},setOrigin:function(t,e){t.getOrigin().setValue(e.x(),e.y(),e.z())},copyOrigin:function(t,e){var r=e.getOrigin();this.setOrigin(t,r)},setBasis:function(t,e){t.setRotation(e)},setBasisFromMatrix3:function(t,e){var r=this.matrix3ToQuaternion(e);this.setBasis(t,r),this.freeQuaternion(r)},setOriginFromArray3:function(t,e){t.getOrigin().setValue(e[0],e[1],e[2])},setOriginFromThreeVector3:function(t,e){t.getOrigin().setValue(e.x,e.y,e.z)},setBasisFromArray3:function(t,e){var r=this.allocThreeQuaternion(),i=this.allocThreeEuler();i.set(e[0],e[1],e[2]),this.setBasisFromThreeQuaternion(t,r.setFromEuler(i)),this.freeThreeEuler(i),this.freeThreeQuaternion(r)},setBasisFromThreeQuaternion:function(t,e){var r=this.allocQuaternion();r.setX(e.x),r.setY(e.y),r.setZ(e.z),r.setW(e.w),this.setBasis(t,r),this.freeQuaternion(r)},multiplyTransforms:function(t,e){var r=this.allocTransform();this.setIdentity(r);var i=this.getBasisAsMatrix3(t),o=this.getBasisAsMatrix3(e),s=this.getOrigin(t),n=this.getOrigin(e),a=this.multiplyMatrix3ByVector3(i,n),h=this.addVector3(a,s);this.setOrigin(r,h);var c=this.multiplyMatrices3(i,o);return this.setBasisFromMatrix3(r,c),this.freeVector3(a),this.freeVector3(h),r},inverseTransform:function(t){var e=this.allocTransform(),r=this.getBasisAsMatrix3(t),i=this.getOrigin(t),o=this.transposeMatrix3(r),s=this.negativeVector3(i),n=this.multiplyMatrix3ByVector3(o,s);return this.setOrigin(e,n),this.setBasisFromMatrix3(e,o),this.freeVector3(s),this.freeVector3(n),e},multiplyMatrices3:function(t,e){var r=[],i=this.rowOfMatrix3(t,0),o=this.rowOfMatrix3(t,1),s=this.rowOfMatrix3(t,2),n=this.columnOfMatrix3(e,0),a=this.columnOfMatrix3(e,1),h=this.columnOfMatrix3(e,2);return r[0]=this.dotVectors3(i,n),r[1]=this.dotVectors3(i,a),r[2]=this.dotVectors3(i,h),r[3]=this.dotVectors3(o,n),r[4]=this.dotVectors3(o,a),r[5]=this.dotVectors3(o,h),r[6]=this.dotVectors3(s,n),r[7]=this.dotVectors3(s,a),r[8]=this.dotVectors3(s,h),this.freeVector3(i),this.freeVector3(o),this.freeVector3(s),this.freeVector3(n),this.freeVector3(a),this.freeVector3(h),r},addVector3:function(t,e){var r=this.allocVector3();return r.setValue(t.x()+e.x(),t.y()+e.y(),t.z()+e.z()),r},dotVectors3:function(t,e){return t.x()*e.x()+t.y()*e.y()+t.z()*e.z()},rowOfMatrix3:function(t,e){var r=this.allocVector3();return r.setValue(t[3*e+0],t[3*e+1],t[3*e+2]),r},columnOfMatrix3:function(t,e){var r=this.allocVector3();return r.setValue(t[e+0],t[e+3],t[e+6]),r},negativeVector3:function(t){var e=this.allocVector3();return e.setValue(-t.x(),-t.y(),-t.z()),e},multiplyMatrix3ByVector3:function(t,e){var r=this.allocVector3(),i=this.rowOfMatrix3(t,0),o=this.rowOfMatrix3(t,1),s=this.rowOfMatrix3(t,2),n=this.dotVectors3(i,e),a=this.dotVectors3(o,e),h=this.dotVectors3(s,e);return r.setValue(n,a,h),this.freeVector3(i),this.freeVector3(o),this.freeVector3(s),r},transposeMatrix3:function(t){var e=[];return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},quaternionToMatrix3:function(t){var e=[],r=t.x(),i=t.y(),o=t.z(),s=t.w(),n=r*r,a=i*i,h=o*o,c=r*i,u=i*o,l=o*r,m=r*s,f=i*s,p=o*s;return e[0]=1-2*(a+h),e[1]=2*(c-p),e[2]=2*(l+f),e[3]=2*(c+p),e[4]=1-2*(h+n),e[5]=2*(u-m),e[6]=2*(l-f),e[7]=2*(u+m),e[8]=1-2*(n+a),e},matrix3ToQuaternion:function(t){var e,r,i,o,s,n=t[0]+t[4]+t[8];n>0?(s=.25*(e=2*Math.sqrt(n+1)),r=(t[7]-t[5])/e,i=(t[2]-t[6])/e,o=(t[3]-t[1])/e):t[0]>t[4]&&t[0]>t[8]?(e=2*Math.sqrt(1+t[0]-t[4]-t[8]),s=(t[7]-t[5])/e,r=.25*e,i=(t[1]+t[3])/e,o=(t[2]+t[6])/e):t[4]>t[8]?(e=2*Math.sqrt(1+t[4]-t[0]-t[8]),s=(t[2]-t[6])/e,r=(t[1]+t[3])/e,i=.25*e,o=(t[5]+t[7])/e):(e=2*Math.sqrt(1+t[8]-t[0]-t[4]),s=(t[3]-t[1])/e,r=(t[2]+t[6])/e,i=(t[5]+t[7])/e,o=.25*e);var a=this.allocQuaternion();return a.setX(r),a.setY(i),a.setZ(o),a.setW(s),a}},r.prototype={constructor:t.RigidBody,reset:function(){return this._setTransformFromBone(),this},updateFromBone:function(){return-1!==this.params.boneIndex&&0===this.params.type&&this._setTransformFromBone(),this},updateBone:function(){return 0===this.params.type||-1===this.params.boneIndex?this:(this._updateBoneRotation(),1===this.params.type&&this._updateBonePosition(),this.bone.updateMatrixWorld(!0),2===this.params.type&&this._setPositionFromBone(),this)},_init:function(){var t=this.manager,e=this.params,r=this.mesh.skeleton.bones,i=-1===e.boneIndex?new Bone:r[e.boneIndex],o=function(t){switch(t.shapeType){case 0:return new Ammo.btSphereShape(t.width);case 1:return new Ammo.btBoxShape(new Ammo.btVector3(t.width,t.height,t.depth));case 2:return new Ammo.btCapsuleShape(t.width,t.height);default:throw"unknown shape type "+t.shapeType}}(e),s=0===e.type?0:e.weight,n=t.allocVector3();n.setValue(0,0,0),0!==s&&o.calculateLocalInertia(s,n);var a=t.allocTransform();t.setIdentity(a),t.setOriginFromArray3(a,e.position),t.setBasisFromArray3(a,e.rotation);var h=t.allocThreeVector3(),c=t.allocTransform();t.setIdentity(c),t.setOriginFromThreeVector3(c,i.getWorldPosition(h));var u=t.multiplyTransforms(c,a),l=new Ammo.btDefaultMotionState(u),m=new Ammo.btRigidBodyConstructionInfo(s,l,o,n);m.set_m_friction(e.friction),m.set_m_restitution(e.restitution);var f=new Ammo.btRigidBody(m);0===e.type&&(f.setCollisionFlags(2|f.getCollisionFlags()),f.setActivationState(4)),f.setDamping(e.positionDamping,e.rotationDamping),f.setSleepingThresholds(0,0),this.world.addRigidBody(f,1<<e.groupIndex,e.groupTarget),this.body=f,this.bone=i,this.boneOffsetForm=a,this.boneOffsetFormInverse=t.inverseTransform(a),t.freeVector3(n),t.freeTransform(u),t.freeTransform(c),t.freeThreeVector3(h)},_getBoneTransform:function(){var t=this.manager,e=t.allocThreeVector3(),r=t.allocThreeQuaternion(),i=t.allocThreeVector3();this.bone.matrixWorld.decompose(e,r,i);var o=t.allocTransform();t.setOriginFromThreeVector3(o,e),t.setBasisFromThreeQuaternion(o,r);var s=t.multiplyTransforms(o,this.boneOffsetForm);return t.freeTransform(o),t.freeThreeVector3(i),t.freeThreeQuaternion(r),t.freeThreeVector3(e),s},_getWorldTransformForBone:function(){var t=this.manager,e=this.body.getCenterOfMassTransform();return t.multiplyTransforms(e,this.boneOffsetFormInverse)},_setTransformFromBone:function(){var t=this.manager,e=this._getBoneTransform();this.body.setCenterOfMassTransform(e),this.body.getMotionState().setWorldTransform(e),t.freeTransform(e)},_setPositionFromBone:function(){var t=this.manager,e=this._getBoneTransform(),r=t.allocTransform();this.body.getMotionState().getWorldTransform(r),t.copyOrigin(r,e),this.body.setCenterOfMassTransform(r),this.body.getMotionState().setWorldTransform(r),t.freeTransform(r),t.freeTransform(e)},_updateBoneRotation:function(){var t=this.manager,e=this._getWorldTransformForBone(),r=t.getBasis(e),i=t.allocThreeQuaternion(),o=t.allocThreeQuaternion(),s=t.allocThreeQuaternion();i.set(r.x(),r.y(),r.z(),r.w()),o.setFromRotationMatrix(this.bone.matrixWorld),o.conjugate(),o.multiply(i),s.setFromRotationMatrix(this.bone.matrix),this.bone.quaternion.copy(o.multiply(s).normalize()),t.freeThreeQuaternion(i),t.freeThreeQuaternion(o),t.freeThreeQuaternion(s),t.freeQuaternion(r),t.freeTransform(e)},_updateBonePosition:function(){var t=this.manager,e=this._getWorldTransformForBone(),r=t.allocThreeVector3(),i=t.getOrigin(e);r.set(i.x(),i.y(),i.z()),this.bone.parent&&this.bone.parent.worldToLocal(r),this.bone.position.copy(r),t.freeThreeVector3(r),t.freeTransform(e)}},i.prototype={constructor:i,_init:function(){var t=this.manager,e=this.params,r=this.bodyA,i=this.bodyB,o=t.allocTransform();t.setIdentity(o),t.setOriginFromArray3(o,e.position),t.setBasisFromArray3(o,e.rotation);var s=t.allocTransform(),n=t.allocTransform();r.body.getMotionState().getWorldTransform(s),i.body.getMotionState().getWorldTransform(n);var a=t.inverseTransform(s),h=t.inverseTransform(n),c=t.multiplyTransforms(a,o),u=t.multiplyTransforms(h,o),l=new Ammo.btGeneric6DofSpringConstraint(r.body,i.body,c,u,!0),m=t.allocVector3(),f=t.allocVector3(),p=t.allocVector3(),d=t.allocVector3();m.setValue(e.translationLimitation1[0],e.translationLimitation1[1],e.translationLimitation1[2]),f.setValue(e.translationLimitation2[0],e.translationLimitation2[1],e.translationLimitation2[2]),p.setValue(e.rotationLimitation1[0],e.rotationLimitation1[1],e.rotationLimitation1[2]),d.setValue(e.rotationLimitation2[0],e.rotationLimitation2[1],e.rotationLimitation2[2]),l.setLinearLowerLimit(m),l.setLinearUpperLimit(f),l.setAngularLowerLimit(p),l.setAngularUpperLimit(d);for(var g=0;g<3;g++)0!==e.springPosition[g]&&(l.enableSpring(g,!0),l.setStiffness(g,e.springPosition[g]));for(g=0;g<3;g++)0!==e.springRotation[g]&&(l.enableSpring(g+3,!0),l.setStiffness(g+3,e.springRotation[g]));if(void 0!==l.setParam)for(g=0;g<6;g++)l.setParam(2,.475,g);this.world.addConstraint(l,!0),this.constraint=l,t.freeTransform(o),t.freeTransform(s),t.freeTransform(n),t.freeTransform(a),t.freeTransform(h),t.freeTransform(c),t.freeTransform(u),t.freeVector3(m),t.freeVector3(f),t.freeVector3(p),t.freeVector3(d)}},o.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:o,updateMatrixWorld:(s=new Vector3,n=new Quaternion,a=new Vector3,h=new Matrix4,function(t){var e=this.root;if(this.visible){var r=this.physics.bodies;h.copy(e.matrixWorld).decompose(s,n,a).compose(s,n,a.set(1,1,1)).getInverse(h);for(var i=0,o=r.length;i<o;i++){var c=r[i].body,u=this.children[i],l=c.getCenterOfMassTransform(),m=l.getOrigin(),f=l.getRotation();u.position.set(m.x(),m.y(),m.z()).applyMatrix4(h),u.quaternion.setFromRotationMatrix(h).multiply(n.set(f.x(),f.y(),f.z(),f.w()))}}this.matrix.copy(e.matrixWorld).decompose(s,n,a).compose(s,n,a.set(1,1,1)),Object3D.prototype.updateMatrixWorld.call(this,t)}),_init:function(){var t=this.physics.bodies;function e(t){switch(t.shapeType){case 0:return new SphereBufferGeometry(t.width,16,8);case 1:return new BoxBufferGeometry(2*t.width,2*t.height,2*t.depth,8,8,8);case 2:return new r(t.width,t.height,16,8);default:return null}}function r(t,e,r,i){var o=new CylinderBufferGeometry(t,t,e,r,i,!0),s=new Mesh(new SphereBufferGeometry(t,r,i,0,2*Math.PI,0,Math.PI/2)),n=new Mesh(new SphereBufferGeometry(t,r,i,0,2*Math.PI,Math.PI/2,Math.PI/2));return s.position.set(0,e/2,0),n.position.set(0,-e/2,0),s.updateMatrix(),n.updateMatrix(),o.merge(s.geometry,s.matrix),o.merge(n.geometry,n.matrix),o}for(var i=0,o=t.length;i<o;i++){var s=t[i].params;this.add(new Mesh(e(s),this.materials[s.type]))}}}),t}();export{MMDPhysics};
//# sourceMappingURL=/sm/5b40ec7c69487b32c9e7df9fbf6945b14d63c7f9af4fce454d75c3b2d918ea02.map