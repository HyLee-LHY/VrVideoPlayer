/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/three@0.117.1/examples/jsm/animation/MMDAnimationHelper.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{AnimationMixer,Object3D,Quaternion,Vector3}from"../../../build/three.module.js";import{CCDIKSolver}from"../animation/CCDIKSolver.js";import{MMDPhysics}from"../animation/MMDPhysics.js";var MMDAnimationHelper=function(){function e(e){e=e||{},this.meshes=[],this.camera=null,this.cameraTarget=new Object3D,this.cameraTarget.name="target",this.audio=null,this.audioManager=null,this.objects=new WeakMap,this.configuration={sync:void 0===e.sync||e.sync,afterglow:void 0!==e.afterglow?e.afterglow:0,resetPhysicsOnLoop:void 0===e.resetPhysicsOnLoop||e.resetPhysicsOnLoop},this.enabled={animation:!0,ik:!0,grant:!0,physics:!0,cameraAnimation:!0},this.onBeforePhysics=function(){},this.sharedPhysics=!1,this.masterPhysics=null}function t(e,t){t=t||{},this.audio=e,this.elapsedTime=0,this.currentTime=0,this.delayTime=void 0!==t.delayTime?t.delayTime:0,this.audioDuration=this.audio.buffer.duration,this.duration=this.audioDuration+this.delayTime}function i(e,t){this.mesh=e,this.grants=t||[]}var s;return e.prototype={constructor:e,add:function(e,t){if(t=t||{},e.isSkinnedMesh)this._addMesh(e,t);else if(e.isCamera)this._setupCamera(e,t);else{if("Audio"!==e.type)throw new Error("THREE.MMDAnimationHelper.add: accepts only THREE.SkinnedMesh or THREE.Camera or THREE.Audio instance.");this._setupAudio(e,t)}return this.configuration.sync&&this._syncDuration(),this},remove:function(e){if(e.isSkinnedMesh)this._removeMesh(e);else if(e.isCamera)this._clearCamera(e);else{if("Audio"!==e.type)throw new Error("THREE.MMDAnimationHelper.remove: accepts only THREE.SkinnedMesh or THREE.Camera or THREE.Audio instance.");this._clearAudio(e)}return this.configuration.sync&&this._syncDuration(),this},update:function(e){null!==this.audioManager&&this.audioManager.control(e);for(var t=0;t<this.meshes.length;t++)this._animateMesh(this.meshes[t],e);return this.sharedPhysics&&this._updateSharedPhysics(e),null!==this.camera&&this._animateCamera(this.camera,e),this},pose:function(e,t,i){!1!==(i=i||{}).resetPose&&e.pose();for(var s=e.skeleton.bones,r=t.bones,a={},n=0,o=s.length;n<o;n++)a[s[n].name]=n;var h=new Vector3,u=new Quaternion;for(n=0,o=r.length;n<o;n++){var c=r[n],l=a[c.name];if(void 0!==l){var d=s[l];d.position.add(h.fromArray(c.translation)),d.quaternion.multiply(u.fromArray(c.quaternion))}}return e.updateMatrixWorld(!0),!1!==i.ik&&this._createCCDIKSolver(e).update(i.saveOriginalBonesBeforeIK),!1!==i.grant&&this.createGrantSolver(e).update(),this},enable:function(e,t){if(void 0===this.enabled[e])throw new Error("THREE.MMDAnimationHelper.enable: unknown key "+e);if(this.enabled[e]=t,"physics"===e)for(var i=0,s=this.meshes.length;i<s;i++)this._optimizeIK(this.meshes[i],t);return this},createGrantSolver:function(e){return new i(e,e.geometry.userData.MMD.grants)},_addMesh:function(e,t){if(this.meshes.indexOf(e)>=0)throw new Error("THREE.MMDAnimationHelper._addMesh: SkinnedMesh '"+e.name+"' has already been added.");return this.meshes.push(e),this.objects.set(e,{looped:!1}),this._setupMeshAnimation(e,t.animation),!1!==t.physics&&this._setupMeshPhysics(e,t),this},_setupCamera:function(e,t){if(this.camera===e)throw new Error("THREE.MMDAnimationHelper._setupCamera: Camera '"+e.name+"' has already been set.");return this.camera&&this.clearCamera(this.camera),this.camera=e,e.add(this.cameraTarget),this.objects.set(e,{}),void 0!==t.animation&&this._setupCameraAnimation(e,t.animation),this},_setupAudio:function(e,i){if(this.audio===e)throw new Error("THREE.MMDAnimationHelper._setupAudio: Audio '"+e.name+"' has already been set.");return this.audio&&this.clearAudio(this.audio),this.audio=e,this.audioManager=new t(e,i),this.objects.set(this.audioManager,{duration:this.audioManager.duration}),this},_removeMesh:function(e){for(var t=!1,i=0,s=0,r=this.meshes.length;s<r;s++)this.meshes[s]!==e?this.meshes[i++]=this.meshes[s]:(this.objects.delete(e),t=!0);if(!t)throw new Error("THREE.MMDAnimationHelper._removeMesh: SkinnedMesh '"+e.name+"' has not been added yet.");return this.meshes.length=i,this},_clearCamera:function(e){if(e!==this.camera)throw new Error("THREE.MMDAnimationHelper._clearCamera: Camera '"+e.name+"' has not been set yet.");return this.camera.remove(this.cameraTarget),this.objects.delete(this.camera),this.camera=null,this},_clearAudio:function(e){if(e!==this.audio)throw new Error("THREE.MMDAnimationHelper._clearAudio: Audio '"+e.name+"' has not been set yet.");return this.objects.delete(this.audioManager),this.audio=null,this.audioManager=null,this},_setupMeshAnimation:function(e,t){var i=this.objects.get(e);if(void 0!==t){var s=Array.isArray(t)?t:[t];i.mixer=new AnimationMixer(e);for(var r=0,a=s.length;r<a;r++)i.mixer.clipAction(s[r]).play();i.mixer.addEventListener("loop",function(e){var t=e.action._clip.tracks;t.length>0&&".bones"!==t[0].name.slice(0,6)||(i.looped=!0)})}return i.ikSolver=this._createCCDIKSolver(e),i.grantSolver=this.createGrantSolver(e),this},_setupCameraAnimation:function(e,t){var i=Array.isArray(t)?t:[t],s=this.objects.get(e);s.mixer=new AnimationMixer(e);for(var r=0,a=i.length;r<a;r++)s.mixer.clipAction(i[r]).play()},_setupMeshPhysics:function(e,t){var i=this.objects.get(e);if(void 0===t.world&&this.sharedPhysics){var s=this._getMasterPhysics();null!==s&&(world=s.world)}i.physics=this._createMMDPhysics(e,t),i.mixer&&!1!==t.animationWarmup&&(this._animateMesh(e,0),i.physics.reset()),i.physics.warmup(void 0!==t.warmup?t.warmup:60),this._optimizeIK(e,!0)},_animateMesh:function(e,t){var i=this.objects.get(e),s=i.mixer,r=i.ikSolver,a=i.grantSolver,n=i.physics,o=i.looped;s&&this.enabled.animation&&(this._restoreBones(e),s.update(t),this._saveBones(e),r&&this.enabled.ik&&(e.updateMatrixWorld(!0),r.update()),a&&this.enabled.grant&&a.update()),!0===o&&this.enabled.physics&&(n&&this.configuration.resetPhysicsOnLoop&&n.reset(),i.looped=!1),n&&this.enabled.physics&&!this.sharedPhysics&&(this.onBeforePhysics(e),n.update(t))},_animateCamera:function(e,t){var i=this.objects.get(e).mixer;i&&this.enabled.cameraAnimation&&(i.update(t),e.updateProjectionMatrix(),e.up.set(0,1,0),e.up.applyQuaternion(e.quaternion),e.lookAt(this.cameraTarget.position))},_optimizeIK:function(e,t){for(var i=e.geometry.userData.MMD.iks,s=e.geometry.userData.MMD.bones,r=0,a=i.length;r<a;r++)for(var n=i[r].links,o=0,h=n.length;o<h;o++){var u=n[o];u.enabled=!0!==t||!(s[u.index].rigidBodyType>0)}},_createCCDIKSolver:function(e){if(void 0===CCDIKSolver)throw new Error("THREE.MMDAnimationHelper: Import CCDIKSolver.");return new CCDIKSolver(e,e.geometry.userData.MMD.iks)},_createMMDPhysics:function(e,t){if(void 0===MMDPhysics)throw new Error("THREE.MMDPhysics: Import MMDPhysics.");return new MMDPhysics(e,e.geometry.userData.MMD.rigidBodies,e.geometry.userData.MMD.constraints,t)},_syncDuration:function(){for(var e=0,t=this.objects,i=this.meshes,s=this.camera,r=this.audioManager,a=0,n=i.length;a<n;a++){if(void 0!==(u=this.objects.get(i[a]).mixer))for(var o=0;o<u._actions.length;o++){var h=u._actions[o]._clip;t.has(h)||t.set(h,{duration:h.duration}),e=Math.max(e,t.get(h).duration)}}if(null!==s&&void 0!==(u=this.objects.get(s).mixer))for(a=0,n=u._actions.length;a<n;a++){h=u._actions[a]._clip;t.has(h)||t.set(h,{duration:h.duration}),e=Math.max(e,t.get(h).duration)}null!==r&&(e=Math.max(e,t.get(r).duration)),e+=this.configuration.afterglow;for(a=0,n=this.meshes.length;a<n;a++){var u;if(void 0!==(u=this.objects.get(this.meshes[a]).mixer)){o=0;for(var c=u._actions.length;o<c;o++)u._actions[o]._clip.duration=e}}if(null!==s&&void 0!==(u=this.objects.get(s).mixer))for(a=0,n=u._actions.length;a<n;a++)u._actions[a]._clip.duration=e;null!==r&&(r.duration=e)},_updatePropertyMixersBuffer:function(e){for(var t=this.objects.get(e).mixer,i=t._bindings,s=t._accuIndex,r=0,a=i.length;r<a;r++){var n=i[r],o=n.buffer,h=(s+1)*n.valueSize;n.binding.getValue(o,h)}},_saveBones:function(e){var t=this.objects.get(e),i=e.skeleton.bones,s=t.backupBones;void 0===s&&(s=new Float32Array(7*i.length),t.backupBones=s);for(var r=0,a=i.length;r<a;r++){var n=i[r];n.position.toArray(s,7*r),n.quaternion.toArray(s,7*r+3)}},_restoreBones:function(e){var t=this.objects.get(e).backupBones;if(void 0!==t)for(var i=e.skeleton.bones,s=0,r=i.length;s<r;s++){var a=i[s];a.position.fromArray(t,7*s),a.quaternion.fromArray(t,7*s+3)}},_getMasterPhysics:function(){if(null!==this.masterPhysics)return this.masterPhysics;for(var e=0,t=this.meshes.length;e<t;e++){var i=this.meshes[e].physics;if(null!=i)return this.masterPhysics=i,this.masterPhysics}return null},_updateSharedPhysics:function(e){if(0!==this.meshes.length&&this.enabled.physics&&this.sharedPhysics){var t=this._getMasterPhysics();if(null!==t){for(var i=0,s=this.meshes.length;i<s;i++){null!=(r=this.meshes[i].physics)&&r.updateRigidBodies()}t.stepSimulation(e);for(i=0,s=this.meshes.length;i<s;i++){var r;null!=(r=this.meshes[i].physics)&&r.updateBones()}}}}},t.prototype={constructor:t,control:function(e){return this.elapsed+=e,this.currentTime+=e,this._shouldStopAudio()&&this.audio.stop(),this._shouldStartAudio()&&this.audio.play(),this},_shouldStartAudio:function(){if(this.audio.isPlaying)return!1;for(;this.currentTime>=this.duration;)this.currentTime-=this.duration;return!(this.currentTime<this.delayTime)&&!(this.currentTime-this.delayTime>this.audioDuration)},_shouldStopAudio:function(){return this.audio.isPlaying&&this.currentTime>=this.duration}},i.prototype={constructor:i,update:(s=new Quaternion,function(){for(var e=this.mesh.skeleton.bones,t=this.grants,i=0,r=t.length;i<r;i++){var a=t[i],n=e[a.index],o=e[a.parentIndex];a.isLocal?(a.affectPosition,a.affectRotation):(a.affectPosition,a.affectRotation&&(s.set(0,0,0,1),s.slerp(o.quaternion,a.ratio),n.quaternion.multiply(s)))}return this})},e}();export{MMDAnimationHelper};
//# sourceMappingURL=/sm/8c8068a206d1e88da060bf5b8ebca076968ef25c357f1c9eadbe32697998caa5.map