/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/three@0.117.1/examples/jsm/loaders/LWOLoader.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{AddOperation,BackSide,BufferAttribute,BufferGeometry,ClampToEdgeWrapping,Color,DoubleSide,EquirectangularReflectionMapping,EquirectangularRefractionMapping,FileLoader,Float32BufferAttribute,FrontSide,LineBasicMaterial,LineSegments,Loader,Mesh,MeshPhongMaterial,MeshPhysicalMaterial,MeshStandardMaterial,MirroredRepeatWrapping,Points,PointsMaterial,RepeatWrapping,TextureLoader,Vector2}from"../../../build/three.module.js";import{IFFParser}from"./lwo/IFFParser.js";var lwoTree,LWOLoader=function(e,r){Loader.call(this,e),r=r||{},this.resourcePath=void 0!==r.resourcePath?r.resourcePath:""};function LWOTreeParser(e){this.textureLoader=e}function MaterialParser(e){this.textureLoader=e}function GeometryParser(){}function extractParentUrl(e,r){var a=e.indexOf(r);return-1===a?"./":e.substr(0,a)}LWOLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:LWOLoader,load:function(e,r,a,t){var s=this,i=""===s.path?extractParentUrl(e,"Objects"):s.path,o=e.split(i).pop().split(".")[0],n=new FileLoader(this.manager);n.setPath(s.path),n.setResponseType("arraybuffer"),n.load(e,function(a){try{r(s.parse(a,i,o))}catch(r){t?t(r):console.error(r),s.manager.itemError(e)}},a,t)},parse:function(e,r,a){return lwoTree=(new IFFParser).parse(e),new LWOTreeParser(new TextureLoader(this.manager).setPath(this.resourcePath||r).setCrossOrigin(this.crossOrigin)).parse(a)}}),LWOTreeParser.prototype={constructor:LWOTreeParser,parse:function(e){return this.materials=new MaterialParser(this.textureLoader).parse(),this.defaultLayerName=e,this.meshes=this.parseLayers(),{materials:this.materials,meshes:this.meshes}},parseLayers(){var e=[],r=[],a=new GeometryParser,t=this;return lwoTree.layers.forEach(function(s){var i=a.parse(s.geometry,s),o=t.parseMesh(i,s);e[s.number]=o,-1===s.parent?r.push(o):e[s.parent].add(o)}),this.applyPivots(r),r},parseMesh(e,r){var a,t=this.getMaterials(e.userData.matNames,r.geometry.type);return this.duplicateUVs(e,t),a="points"===r.geometry.type?new Points(e,t):"lines"===r.geometry.type?new LineSegments(e,t):new Mesh(e,t),r.name?a.name=r.name:a.name=this.defaultLayerName+"_layer_"+r.number,a.userData.pivot=r.pivot,a},applyPivots(e){e.forEach(function(e){e.traverse(function(e){var r=e.userData.pivot;if(e.position.x+=r[0],e.position.y+=r[1],e.position.z+=r[2],e.parent){var a=e.parent.userData.pivot;e.position.x-=a[0],e.position.y-=a[1],e.position.z-=a[2]}})})},getMaterials(e,r){var a=[],t=this;e.forEach(function(e,r){a[r]=t.getMaterialByName(e)}),"points"!==r&&"lines"!==r||a.forEach(function(e,t){var s={color:e.color};"points"===r?(s.size=.1,s.map=e.map,s.morphTargets=e.morphTargets,a[t]=new PointsMaterial(s)):"lines"===r&&(a[t]=new LineBasicMaterial(s))});var s=a.filter(Boolean);return 1===s.length?s[0]:a},getMaterialByName(e){return this.materials.filter(function(r){return r.name===e})[0]},duplicateUVs(e,r){var a=!1;Array.isArray(r)?r.forEach(function(e){e.aoMap&&(a=!0)}):r.aoMap&&(a=!0),a&&e.setAttribute("uv2",new BufferAttribute(e.attributes.uv.array,2))}},MaterialParser.prototype={constructor:MaterialParser,parse:function(){var e=[];for(var r in this.textures={},lwoTree.materials)"LWO3"===lwoTree.format?e.push(this.parseMaterial(lwoTree.materials[r],r,lwoTree.textures)):"LWO2"===lwoTree.format&&e.push(this.parseMaterialLwo2(lwoTree.materials[r],r,lwoTree.textures));return e},parseMaterial(e,r,a){var t={name:r,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)},s=this.parseConnections(e.connections,e.nodes),i=this.parseTextureNodes(s.maps);this.parseAttributeImageMaps(s.attributes,a,i,e.maps);var o=this.parseAttributes(s.attributes,i);return this.parseEnvMap(s,i,o),t=Object.assign(i,t),t=Object.assign(t,o),new(this.getMaterialType(s.attributes))(t)},parseMaterialLwo2(e,r){var a={name:r,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)},t=this.parseAttributes(e.attributes,{});return a=Object.assign(a,t),new MeshPhongMaterial(a)},getSide(e){if(!e.side)return BackSide;switch(e.side){case 0:case 1:return BackSide;case 2:return FrontSide;case 3:return DoubleSide}},getSmooth:e=>!e.smooth||!e.smooth,parseConnections(e,r){var a={maps:{}},t=e.inputName,s=e.inputNodeName,i=e.nodeName,o=this;return t.forEach(function(e,t){if("Material"===e){var i=o.getNodeByRefName(s[t],r);a.attributes=i.attributes,a.envMap=i.fileName,a.name=s[t]}}),i.forEach(function(e,i){e===a.name&&(a.maps[t[i]]=o.getNodeByRefName(s[i],r))}),a},getNodeByRefName(e,r){for(var a in r)if(r[a].refName===e)return r[a]},parseTextureNodes(e){var r={};for(var a in e){var t=e[a],s=t.fileName;if(!s)return;var i=this.loadTexture(s);switch(void 0!==t.widthWrappingMode&&(i.wrapS=this.getWrappingType(t.widthWrappingMode)),void 0!==t.heightWrappingMode&&(i.wrapT=this.getWrappingType(t.heightWrappingMode)),a){case"Color":r.map=i;break;case"Roughness":r.roughnessMap=i,r.roughness=.5;break;case"Specular":r.specularMap=i,r.specular=16777215;break;case"Luminous":r.emissiveMap=i,r.emissive=8421504;break;case"Luminous Color":r.emissive=8421504;break;case"Metallic":r.metalnessMap=i,r.metalness=.5;break;case"Transparency":case"Alpha":r.alphaMap=i,r.transparent=!0;break;case"Normal":r.normalMap=i,void 0!==t.amplitude&&(r.normalScale=new Vector2(t.amplitude,t.amplitude));break;case"Bump":r.bumpMap=i}}return r.roughnessMap&&r.specularMap&&delete r.specularMap,r},parseAttributeImageMaps(e,r,a){for(var t in e){var s=e[t];if(s.maps){var i=s.maps[0],o=this.getTexturePathByIndex(i.imageIndex,r);if(!o)return;var n=this.loadTexture(o);switch(void 0!==i.wrap&&(n.wrapS=this.getWrappingType(i.wrap.w)),void 0!==i.wrap&&(n.wrapT=this.getWrappingType(i.wrap.h)),t){case"Color":a.map=n;break;case"Diffuse":a.aoMap=n;break;case"Roughness":a.roughnessMap=n,a.roughness=1;break;case"Specular":a.specularMap=n,a.specular=16777215;break;case"Luminosity":a.emissiveMap=n,a.emissive=8421504;break;case"Metallic":a.metalnessMap=n,a.metalness=1;break;case"Transparency":case"Alpha":a.alphaMap=n,a.transparent=!0;break;case"Normal":a.normalMap=n;break;case"Bump":a.bumpMap=n}}}},parseAttributes(e,r){var a={};return e.Color&&!r.map?a.color=(new Color).fromArray(e.Color.value):a.color=new Color,e.Transparency&&0!==e.Transparency.value&&(a.opacity=1-e.Transparency.value,a.transparent=!0),e["Bump Height"]&&(a.bumpScale=.1*e["Bump Height"].value),e["Refraction Index"]&&(a.refractionRatio=1/e["Refraction Index"].value),this.parsePhysicalAttributes(a,e,r),this.parseStandardAttributes(a,e,r),this.parsePhongAttributes(a,e,r),a},parsePhysicalAttributes(e,r){r.Clearcoat&&r.Clearcoat.value>0&&(e.clearcoat=r.Clearcoat.value,r["Clearcoat Gloss"]&&(e.clearcoatRoughness=.5*(1-r["Clearcoat Gloss"].value)))},parseStandardAttributes(e,r,a){r.Luminous&&(e.emissiveIntensity=r.Luminous.value,r["Luminous Color"]&&!a.emissive?e.emissive=(new Color).fromArray(r["Luminous Color"].value):e.emissive=new Color(8421504)),r.Roughness&&!a.roughnessMap&&(e.roughness=r.Roughness.value),r.Metallic&&!a.metalnessMap&&(e.metalness=r.Metallic.value)},parsePhongAttributes(e,r,a){r.Diffuse&&e.color.multiplyScalar(r.Diffuse.value),r.Reflection&&(e.reflectivity=r.Reflection.value,e.combine=AddOperation),r.Luminosity&&(e.emissiveIntensity=r.Luminosity.value,a.emissiveMap||a.map?e.emissive=new Color(8421504):e.emissive=e.color),r.Roughness||!r.Specular||a.specularMap||(r["Color Highlight"]?e.specular=(new Color).setScalar(r.Specular.value).lerp(e.color.clone().multiplyScalar(r.Specular.value),r["Color Highlight"].value):e.specular=(new Color).setScalar(r.Specular.value)),e.specular&&r.Glossiness&&(e.shininess=7+Math.pow(2,12*r.Glossiness.value+2))},parseEnvMap(e,r,a){if(e.envMap){var t=this.loadTexture(e.envMap);a.transparent&&a.opacity<.999?(t.mapping=EquirectangularRefractionMapping,void 0!==a.reflectivity&&(delete a.reflectivity,delete a.combine),void 0!==a.metalness&&delete a.metalness):t.mapping=EquirectangularReflectionMapping,r.envMap=t}},getTexturePathByIndex(e){var r="";return lwoTree.textures?(lwoTree.textures.forEach(function(a){a.index===e&&(r=a.fileName)}),r):r},loadTexture(e){return e?this.textureLoader.load(e,void 0,void 0,function(){console.warn("LWOLoader: non-standard resource hierarchy. Use `resourcePath` parameter to specify root content directory.")}):null},getWrappingType(e){switch(e){case 0:return console.warn('LWOLoader: "Reset" texture wrapping type is not supported in three.js'),ClampToEdgeWrapping;case 1:return RepeatWrapping;case 2:return MirroredRepeatWrapping;case 3:return ClampToEdgeWrapping}},getMaterialType:e=>e.Clearcoat&&e.Clearcoat.value>0?MeshPhysicalMaterial:e.Roughness?MeshStandardMaterial:MeshPhongMaterial},GeometryParser.prototype={constructor:GeometryParser,parse(e,r){var a=new BufferGeometry;a.setAttribute("position",new Float32BufferAttribute(e.points,3));var t=this.splitIndices(e.vertexIndices,e.polygonDimensions);return a.setIndex(t),this.parseGroups(a,e),a.computeVertexNormals(),this.parseUVs(a,r,t),this.parseMorphTargets(a,r,t),a.translate(-r.pivot[0],-r.pivot[1],-r.pivot[2]),a},splitIndices(e,r){var a=[],t=0;return r.forEach(function(r){if(r<4)for(var s=0;s<r;s++)a.push(e[t+s]);else if(4===r)a.push(e[t],e[t+1],e[t+2],e[t],e[t+2],e[t+3]);else if(r>4){for(s=1;s<r-1;s++)a.push(e[t],e[t+s],e[t+s+1]);console.warn("LWOLoader: polygons with greater than 4 sides are not supported")}t+=r}),a},parseGroups(e,r){var a=lwoTree.tags,t=[],s=3;"lines"===r.type&&(s=2),"points"===r.type&&(s=1);for(var i,o=this.splitMaterialIndices(r.polygonDimensions,r.materialIndices),n=0,p={},u=0,l=0,c=0;c<o.length;c+=2){var h,m=o[c+1];if(0===c&&(t[n]=a[m]),void 0===i&&(i=m),m!==i)p[a[i]]?h=p[a[i]]:(h=n,p[a[i]]=n,t[n]=a[i],n++),e.addGroup(u,l,h),u+=l,i=m,l=0;l+=s}e.groups.length>0&&(p[a[m]]?h=p[a[m]]:(h=n,p[a[m]]=n,t[n]=a[m]),e.addGroup(u,l,h));e.userData.matNames=t},splitMaterialIndices(e,r){var a=[];return e.forEach(function(e,t){if(e<=3)a.push(r[2*t],r[2*t+1]);else if(4===e)a.push(r[2*t],r[2*t+1],r[2*t],r[2*t+1]);else for(var s=0;s<e-2;s++)a.push(r[2*t],r[2*t+1])}),a},parseUVs(e,r){var a=Array.from(Array(2*e.attributes.position.count),function(){return 0});for(var t in r.uvs){var s=r.uvs[t].uvs;r.uvs[t].uvIndices.forEach(function(e,r){a[2*e]=s[2*r],a[2*e+1]=s[2*r+1]})}e.setAttribute("uv",new Float32BufferAttribute(a,2))},parseMorphTargets(e,r){var a=0;for(var t in r.morphTargets){var s=e.attributes.position.array.slice();e.morphAttributes.position||(e.morphAttributes.position=[]);var i=r.morphTargets[t].points,o=r.morphTargets[t].indices,n=r.morphTargets[t].type;o.forEach(function(e,r){"relative"===n?(s[3*e]+=i[3*r],s[3*e+1]+=i[3*r+1],s[3*e+2]+=i[3*r+2]):(s[3*e]=i[3*r],s[3*e+1]=i[3*r+1],s[3*e+2]=i[3*r+2])}),e.morphAttributes.position[a]=new Float32BufferAttribute(s,3),e.morphAttributes.position[a].name=t,a++}e.morphTargetsRelative=!1}};export{LWOLoader};
//# sourceMappingURL=/sm/f9896a05c03eadd1a367ab30212cab87df7ecf595bec19833c9caf8831094aba.map