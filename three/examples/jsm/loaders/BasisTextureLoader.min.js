/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/three@0.117.1/examples/jsm/loaders/BasisTextureLoader.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{CompressedTexture,FileLoader,LinearFilter,LinearMipmapLinearFilter,Loader,RGBA_ASTC_4x4_Format,RGBA_BPTC_Format,RGBA_PVRTC_4BPPV1_Format,RGB_ETC1_Format,RGB_PVRTC_4BPPV1_Format,UnsignedByteType}from"../../../build/three.module.js";var BasisTextureLoader=function(e){Loader.call(this,e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig={format:null,astcSupported:!1,bptcSupported:!1,etcSupported:!1,dxtSupported:!1,pvrtcSupported:!1}};BasisTextureLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:BasisTextureLoader,setTranscoderPath:function(e){return this.transcoderPath=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},detectSupport:function(e){var r=this.workerConfig;if(r.astcSupported=!!e.extensions.get("WEBGL_compressed_texture_astc"),r.bptcSupported=!!e.extensions.get("EXT_texture_compression_bptc"),r.etcSupported=!!e.extensions.get("WEBGL_compressed_texture_etc1"),r.dxtSupported=!!e.extensions.get("WEBGL_compressed_texture_s3tc"),r.pvrtcSupported=!!e.extensions.get("WEBGL_compressed_texture_pvrtc")||!!e.extensions.get("WEBKIT_WEBGL_compressed_texture_pvrtc"),r.astcSupported)r.format=BasisTextureLoader.BASIS_FORMAT.cTFASTC_4x4;else if(r.bptcSupported)r.format=BasisTextureLoader.BASIS_FORMAT.cTFBC7_M5;else if(r.dxtSupported)r.format=BasisTextureLoader.BASIS_FORMAT.cTFBC3;else if(r.pvrtcSupported)r.format=BasisTextureLoader.BASIS_FORMAT.cTFPVRTC1_4_RGBA;else{if(!r.etcSupported)throw new Error("THREE.BasisTextureLoader: No suitable compressed texture format found.");r.format=BasisTextureLoader.BASIS_FORMAT.cTFETC1}return this},load:function(e,r,t,a){var s=new FileLoader(this.manager);s.setResponseType("arraybuffer"),s.load(e,e=>{this._createTexture(e).then(r).catch(a)},t,a)},_createTexture:function(e){var r,t,a=e.byteLength,s=this._allocateWorker(a).then(a=>(r=a,t=this.workerNextTaskID++,new Promise((a,s)=>{r._callbacks[t]={resolve:a,reject:s},r.postMessage({type:"transcode",id:t,buffer:e},[e])}))).then(e=>{var r,t=this.workerConfig,{width:a,height:s,mipmaps:o,format:i}=e;switch(i){case BasisTextureLoader.BASIS_FORMAT.cTFASTC_4x4:r=new CompressedTexture(o,a,s,RGBA_ASTC_4x4_Format);break;case BasisTextureLoader.BASIS_FORMAT.cTFBC7_M5:r=new CompressedTexture(o,a,s,RGBA_BPTC_Format);break;case BasisTextureLoader.BASIS_FORMAT.cTFBC1:case BasisTextureLoader.BASIS_FORMAT.cTFBC3:r=new CompressedTexture(o,a,s,BasisTextureLoader.DXT_FORMAT_MAP[t.format],UnsignedByteType);break;case BasisTextureLoader.BASIS_FORMAT.cTFETC1:r=new CompressedTexture(o,a,s,RGB_ETC1_Format);break;case BasisTextureLoader.BASIS_FORMAT.cTFPVRTC1_4_RGB:r=new CompressedTexture(o,a,s,RGB_PVRTC_4BPPV1_Format);break;case BasisTextureLoader.BASIS_FORMAT.cTFPVRTC1_4_RGBA:r=new CompressedTexture(o,a,s,RGBA_PVRTC_4BPPV1_Format);break;default:throw new Error("THREE.BasisTextureLoader: No supported format available.")}return r.minFilter=1===o.length?LinearFilter:LinearMipmapLinearFilter,r.magFilter=LinearFilter,r.generateMipmaps=!1,r.needsUpdate=!0,r});return s.catch(()=>!0).then(()=>{r&&t&&(r._taskLoad-=a,delete r._callbacks[t])}),s},_initTranscoder:function(){if(!this.transcoderPending){var e=new FileLoader(this.manager);e.setPath(this.transcoderPath);var r=new Promise((r,t)=>{e.load("basis_transcoder.js",r,void 0,t)}),t=new FileLoader(this.manager);t.setPath(this.transcoderPath),t.setResponseType("arraybuffer");var a=new Promise((e,r)=>{t.load("basis_transcoder.wasm",e,void 0,r)});this.transcoderPending=Promise.all([r,a]).then(([e,r])=>{var t=BasisTextureLoader.BasisWorker.toString(),a=["/* basis_transcoder.js */",e,"/* worker */",t.substring(t.indexOf("{")+1,t.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([a])),this.transcoderBinary=r})}return this.transcoderPending},_allocateWorker:function(e){return this._initTranscoder().then(()=>{var r;this.workerPool.length<this.workerLimit?((r=new Worker(this.workerSourceURL))._callbacks={},r._taskLoad=0,r.postMessage({type:"init",config:this.workerConfig,transcoderBinary:this.transcoderBinary}),r.onmessage=function(e){var t=e.data;switch(t.type){case"transcode":r._callbacks[t.id].resolve(t);break;case"error":r._callbacks[t.id].reject(t);break;default:console.error('THREE.BasisTextureLoader: Unexpected message, "'+t.type+'"')}},this.workerPool.push(r)):this.workerPool.sort(function(e,r){return e._taskLoad>r._taskLoad?-1:1});return(r=this.workerPool[this.workerPool.length-1])._taskLoad+=e,r})},dispose:function(){for(var e=0;e<this.workerPool.length;e++)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),BasisTextureLoader.BASIS_FORMAT={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC4:4,cTFBC5:5,cTFBC7_M6_OPAQUE_ONLY:6,cTFBC7_M5:7,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFBGR565:15,cTFRGBA4444:16},BasisTextureLoader.DXT_FORMAT={COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779},BasisTextureLoader.DXT_FORMAT_MAP={},BasisTextureLoader.DXT_FORMAT_MAP[BasisTextureLoader.BASIS_FORMAT.cTFBC1]=BasisTextureLoader.DXT_FORMAT.COMPRESSED_RGB_S3TC_DXT1_EXT,BasisTextureLoader.DXT_FORMAT_MAP[BasisTextureLoader.BASIS_FORMAT.cTFBC3]=BasisTextureLoader.DXT_FORMAT.COMPRESSED_RGBA_S3TC_DXT5_EXT,BasisTextureLoader.BasisWorker=function(){var e,r,t;onmessage=function(a){var s,o,i=a.data;switch(i.type){case"init":e=i.config,s=i.transcoderBinary,r=new Promise(e=>{o={wasmBinary:s,onRuntimeInitialized:e},BASIS(o)}).then(()=>{var{BasisFile:e,initializeBasis:r}=o;t=e,r()});break;case"transcode":r.then(()=>{try{for(var{width:r,height:a,hasAlpha:s,mipmaps:o,format:n}=function(r){var a=new t(new Uint8Array(r)),s=a.getImageWidth(0,0),o=a.getImageHeight(0,0),i=a.getNumLevels(0),n=a.getHasAlpha();function T(){a.close(),a.delete()}if(!n)switch(e.format){case 9:e.format=8}if(!s||!o||!i)throw T(),new Error("THREE.BasisTextureLoader:  Invalid .basis file");if(!a.startTranscoding())throw T(),new Error("THREE.BasisTextureLoader: .startTranscoding failed");for(var c=[],d=0;d<i;d++){var _=a.getImageWidth(0,d),u=a.getImageHeight(0,d),B=new Uint8Array(a.getImageTranscodedSizeInBytes(0,d,e.format)),h=a.transcodeImage(B,0,d,e.format,0,n);if(!h)throw T(),new Error("THREE.BasisTextureLoader: .transcodeImage failed.");c.push({data:B,width:_,height:u})}return T(),{width:s,height:o,hasAlpha:n,mipmaps:c,format:e.format}}(i.buffer),T=[],c=0;c<o.length;++c)T.push(o[c].data.buffer);self.postMessage({type:"transcode",id:i.id,width:r,height:a,hasAlpha:s,mipmaps:o,format:n},T)}catch(e){console.error(e),self.postMessage({type:"error",id:i.id,error:e.message})}})}}};export{BasisTextureLoader};
//# sourceMappingURL=/sm/977174535a9d3e11bd54d517493421b3e8e7471022f52c958d171ca2cedfe55b.map