/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/three@0.117.1/src/renderers/webgl/WebGLShadowMap.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{FrontSide,BackSide,DoubleSide,RGBAFormat,NearestFilter,LinearFilter,PCFShadowMap,VSMShadowMap,RGBADepthPacking,NoBlending}from"../../constants.js";import{WebGLRenderTarget}from"../WebGLRenderTarget.js";import{MeshDepthMaterial}from"../../materials/MeshDepthMaterial.js";import{MeshDistanceMaterial}from"../../materials/MeshDistanceMaterial.js";import{ShaderMaterial}from"../../materials/ShaderMaterial.js";import{BufferAttribute}from"../../core/BufferAttribute.js";import{BufferGeometry}from"../../core/BufferGeometry.js";import{Mesh}from"../../objects/Mesh.js";import{Vector4}from"../../math/Vector4.js";import{Vector2}from"../../math/Vector2.js";import{Frustum}from"../../math/Frustum.js";import vsm_frag from"../shaders/ShaderLib/vsm_frag.glsl.js";import vsm_vert from"../shaders/ShaderLib/vsm_vert.glsl.js";function WebGLShadowMap(e,r,a){var t=new Frustum,i=new Vector2,s=new Vector2,n=new Vector4,o=[],l=[],d={},m={0:BackSide,1:FrontSide,2:DoubleSide},p=new ShaderMaterial({defines:{SAMPLE_RATE:.25,HALF_SAMPLE_RATE:1/8},uniforms:{shadow_pass:{value:null},resolution:{value:new Vector2},radius:{value:4}},vertexShader:vsm_vert,fragmentShader:vsm_frag}),u=p.clone();u.defines.HORIZONAL_PASS=1;var h=new BufferGeometry;h.setAttribute("position",new BufferAttribute(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));var f=new Mesh(h,p),c=this;function w(a,t){var i=r.update(f);p.uniforms.shadow_pass.value=a.map.texture,p.uniforms.resolution.value=a.mapSize,p.uniforms.radius.value=a.radius,e.setRenderTarget(a.mapPass),e.clear(),e.renderBufferDirect(t,null,i,p,f,null),u.uniforms.shadow_pass.value=a.mapPass.texture,u.uniforms.resolution.value=a.mapSize,u.uniforms.radius.value=a.radius,e.setRenderTarget(a.map),e.clear(),e.renderBufferDirect(t,null,i,u,f,null)}function v(e,r,a){var t=e<<0|r<<1|a<<2,i=o[t];return void 0===i&&(i=new MeshDepthMaterial({depthPacking:RGBADepthPacking,morphTargets:e,skinning:r}),o[t]=i),i}function M(e,r,a){var t=e<<0|r<<1|a<<2,i=l[t];return void 0===i&&(i=new MeshDistanceMaterial({morphTargets:e,skinning:r}),l[t]=i),i}function g(r,a,t,i,s,n,o){var l=null,p=v,u=r.customDepthMaterial;if(!0===i.isPointLight&&(p=M,u=r.customDistanceMaterial),void 0===u){var h=!1;!0===t.morphTargets&&(h=a.morphAttributes&&a.morphAttributes.position&&a.morphAttributes.position.length>0);var f=!1;!0===r.isSkinnedMesh&&(!0===t.skinning?f=!0:console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",r)),l=p(h,f,!0===r.isInstancedMesh)}else l=u;if(e.localClippingEnabled&&!0===t.clipShadows&&0!==t.clippingPlanes.length){var c=l.uuid,w=t.uuid,g=d[c];void 0===g&&(g={},d[c]=g);var S=g[w];void 0===S&&(S=l.clone(),g[w]=S),l=S}return l.visible=t.visible,l.wireframe=t.wireframe,l.side=o===VSMShadowMap?null!==t.shadowSide?t.shadowSide:t.side:null!==t.shadowSide?t.shadowSide:m[t.side],l.clipShadows=t.clipShadows,l.clippingPlanes=t.clippingPlanes,l.clipIntersection=t.clipIntersection,l.wireframeLinewidth=t.wireframeLinewidth,l.linewidth=t.linewidth,!0===i.isPointLight&&!0===l.isMeshDistanceMaterial&&(l.referencePosition.setFromMatrixPosition(i.matrixWorld),l.nearDistance=s,l.farDistance=n),l}function S(a,i,s,n,o){if(!1!==a.visible){if(a.layers.test(i.layers)&&(a.isMesh||a.isLine||a.isPoints)&&(a.castShadow||a.receiveShadow&&o===VSMShadowMap)&&(!a.frustumCulled||t.intersectsObject(a))){a.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,a.matrixWorld);var l=r.update(a),d=a.material;if(Array.isArray(d))for(var m=l.groups,p=0,u=m.length;p<u;p++){var h=m[p],f=d[h.materialIndex];if(f&&f.visible){var c=g(a,l,f,n,s.near,s.far,o);e.renderBufferDirect(s,null,l,c,a,h)}}else if(d.visible){c=g(a,l,d,n,s.near,s.far,o);e.renderBufferDirect(s,null,l,c,a,null)}}for(var w=a.children,v=0,M=w.length;v<M;v++)S(w[v],i,s,n,o)}}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=PCFShadowMap,this.render=function(r,o,l){if(!1!==c.enabled&&(!1!==c.autoUpdate||!1!==c.needsUpdate)&&0!==r.length){var d=e.getRenderTarget(),m=e.getActiveCubeFace(),p=e.getActiveMipmapLevel(),u=e.state;u.setBlending(NoBlending),u.buffers.color.setClear(1,1,1,1),u.buffers.depth.setTest(!0),u.setScissorTest(!1);for(var h=0,f=r.length;h<f;h++){var v=r[h],M=v.shadow;if(void 0!==M){i.copy(M.mapSize);var g=M.getFrameExtents();if(i.multiply(g),s.copy(M.mapSize),(i.x>a||i.y>a)&&(i.x>a&&(s.x=Math.floor(a/g.x),i.x=s.x*g.x,M.mapSize.x=s.x),i.y>a&&(s.y=Math.floor(a/g.y),i.y=s.y*g.y,M.mapSize.y=s.y)),null===M.map&&!M.isPointLightShadow&&this.type===VSMShadowMap){var b={minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat};M.map=new WebGLRenderTarget(i.x,i.y,b),M.map.texture.name=v.name+".shadowMap",M.mapPass=new WebGLRenderTarget(i.x,i.y,b),M.camera.updateProjectionMatrix()}if(null===M.map){b={minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat};M.map=new WebGLRenderTarget(i.x,i.y,b),M.map.texture.name=v.name+".shadowMap",M.camera.updateProjectionMatrix()}e.setRenderTarget(M.map),e.clear();for(var y=M.getViewportCount(),x=0;x<y;x++){var F=M.getViewport(x);n.set(s.x*F.x,s.y*F.y,s.x*F.z,s.y*F.w),u.viewport(n),M.updateMatrices(v,x),t=M.getFrustum(),S(o,l,M.camera,v,this.type)}M.isPointLightShadow||this.type!==VSMShadowMap||w(M,l)}else console.warn("THREE.WebGLShadowMap:",v,"has no shadow.")}c.needsUpdate=!1,e.setRenderTarget(d,m,p)}}}export{WebGLShadowMap};
//# sourceMappingURL=/sm/cc67c82ec61079d69ad939e3a23473872b0a90232960fc69fe25c1198cf2c1db.map