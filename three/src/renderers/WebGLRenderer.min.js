/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/three@0.117.1/src/renderers/WebGLRenderer.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{RGBAFormat,HalfFloatType,FloatType,UnsignedByteType,LinearEncoding,NoToneMapping}from"../constants.js";import{MathUtils}from"../math/MathUtils.js";import{DataTexture}from"../textures/DataTexture.js";import{Frustum}from"../math/Frustum.js";import{Matrix4}from"../math/Matrix4.js";import{UniformsLib}from"./shaders/UniformsLib.js";import{Vector2}from"../math/Vector2.js";import{Vector3}from"../math/Vector3.js";import{Vector4}from"../math/Vector4.js";import{Scene}from"../scenes/Scene.js";import{WebGLAnimation}from"./webgl/WebGLAnimation.js";import{WebGLAttributes}from"./webgl/WebGLAttributes.js";import{WebGLBackground}from"./webgl/WebGLBackground.js";import{WebGLBufferRenderer}from"./webgl/WebGLBufferRenderer.js";import{WebGLCapabilities}from"./webgl/WebGLCapabilities.js";import{WebGLClipping}from"./webgl/WebGLClipping.js";import{WebGLExtensions}from"./webgl/WebGLExtensions.js";import{WebGLGeometries}from"./webgl/WebGLGeometries.js";import{WebGLIndexedBufferRenderer}from"./webgl/WebGLIndexedBufferRenderer.js";import{WebGLInfo}from"./webgl/WebGLInfo.js";import{WebGLMorphtargets}from"./webgl/WebGLMorphtargets.js";import{WebGLObjects}from"./webgl/WebGLObjects.js";import{WebGLPrograms}from"./webgl/WebGLPrograms.js";import{WebGLProperties}from"./webgl/WebGLProperties.js";import{WebGLRenderLists}from"./webgl/WebGLRenderLists.js";import{WebGLRenderStates}from"./webgl/WebGLRenderStates.js";import{WebGLShadowMap}from"./webgl/WebGLShadowMap.js";import{WebGLState}from"./webgl/WebGLState.js";import{WebGLTextures}from"./webgl/WebGLTextures.js";import{WebGLUniforms}from"./webgl/WebGLUniforms.js";import{WebGLUtils}from"./webgl/WebGLUtils.js";import{WebXRManager}from"./webxr/WebXRManager.js";import{WebGLMaterials}from"./webgl/WebGLMaterials.js";function WebGLRenderer(e){var t=void 0!==(e=e||{}).canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),r=void 0!==e.context?e.context:null,i=void 0!==e.alpha&&e.alpha,a=void 0===e.depth||e.depth,n=void 0===e.stencil||e.stencil,o=void 0!==e.antialias&&e.antialias,s=void 0===e.premultipliedAlpha||e.premultipliedAlpha,l=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,u=void 0!==e.powerPreference?e.powerPreference:"default",d=void 0!==e.failIfMajorPerformanceCaveat&&e.failIfMajorPerformanceCaveat,f=null,p=null;this.domElement=t,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=LinearEncoding,this.physicallyCorrectLights=!1,this.toneMapping=NoToneMapping,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var m,h,c,g,b,v,M,L,w,x,R,A,T,E,S,W,_,G,y,F=this,P=!1,C=null,B=0,U=0,I=null,D=null,V=-1,j={geometry:null,program:null,wireframe:!1},O=null,N=null,z=new Vector4,H=new Vector4,k=null,Y=t.width,X=t.height,q=1,K=null,J=null,Q=new Vector4(0,0,Y,X),Z=new Vector4(0,0,Y,X),$=!1,ee=new Frustum,te=new WebGLClipping,re=!1,ie=!1,ae=new Matrix4,ne=new Vector3;function oe(){return null===I?q:1}try{var se={alpha:i,depth:a,stencil:n,antialias:o,premultipliedAlpha:s,preserveDrawingBuffer:l,powerPreference:u,failIfMajorPerformanceCaveat:d};if(t.addEventListener("webglcontextlost",fe,!1),t.addEventListener("webglcontextrestored",pe,!1),null===(m=r||t.getContext("webgl",se)||t.getContext("experimental-webgl",se)))throw null!==t.getContext("webgl")?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.");void 0===m.getShaderPrecisionFormat&&(m.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}function le(){h=new WebGLExtensions(m),!1===(c=new WebGLCapabilities(m,h,e)).isWebGL2&&(h.get("WEBGL_depth_texture"),h.get("OES_texture_float"),h.get("OES_texture_half_float"),h.get("OES_texture_half_float_linear"),h.get("OES_standard_derivatives"),h.get("OES_element_index_uint"),h.get("ANGLE_instanced_arrays")),h.get("OES_texture_float_linear"),y=new WebGLUtils(m,h,c),(g=new WebGLState(m,h,c)).scissor(H.copy(Z).multiplyScalar(q).floor()),g.viewport(z.copy(Q).multiplyScalar(q).floor()),b=new WebGLInfo(m),v=new WebGLProperties,M=new WebGLTextures(m,h,g,v,c,y,b),L=new WebGLAttributes(m,c),w=new WebGLGeometries(m,L,b),x=new WebGLObjects(m,w,L,b),W=new WebGLMorphtargets(m),R=new WebGLPrograms(F,h,c),A=new WebGLMaterials(v),T=new WebGLRenderLists,E=new WebGLRenderStates,S=new WebGLBackground(F,g,x,s),_=new WebGLBufferRenderer(m,h,b,c),G=new WebGLIndexedBufferRenderer(m,h,b,c),b.programs=R.programs,F.capabilities=c,F.extensions=h,F.properties=v,F.renderLists=T,F.state=g,F.info=b}le();var ue=new WebXRManager(F,m);this.xr=ue;var de=new WebGLShadowMap(F,x,c.maxTextureSize);function fe(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),P=!0}function pe(){console.log("THREE.WebGLRenderer: Context Restored."),P=!1,le()}function me(e){var t=e.target;t.removeEventListener("dispose",me),function(e){he(e),v.remove(e)}(t)}function he(e){var t=v.get(e).program;e.program=void 0,void 0!==t&&R.releaseProgram(t)}this.shadowMap=de,this.getContext=function(){return m},this.getContextAttributes=function(){return m.getContextAttributes()},this.forceContextLoss=function(){var e=h.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){var e=h.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return q},this.setPixelRatio=function(e){void 0!==e&&(q=e,this.setSize(Y,X,!1))},this.getSize=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getsize() now requires a Vector2 as an argument"),e=new Vector2),e.set(Y,X)},this.setSize=function(e,r,i){ue.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(Y=e,X=r,t.width=Math.floor(e*q),t.height=Math.floor(r*q),!1!==i&&(t.style.width=e+"px",t.style.height=r+"px"),this.setViewport(0,0,e,r))},this.getDrawingBufferSize=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getdrawingBufferSize() now requires a Vector2 as an argument"),e=new Vector2),e.set(Y*q,X*q).floor()},this.setDrawingBufferSize=function(e,r,i){Y=e,X=r,q=i,t.width=Math.floor(e*i),t.height=Math.floor(r*i),this.setViewport(0,0,e,r)},this.getCurrentViewport=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getCurrentViewport() now requires a Vector4 as an argument"),e=new Vector4),e.copy(z)},this.getViewport=function(e){return e.copy(Q)},this.setViewport=function(e,t,r,i){e.isVector4?Q.set(e.x,e.y,e.z,e.w):Q.set(e,t,r,i),g.viewport(z.copy(Q).multiplyScalar(q).floor())},this.getScissor=function(e){return e.copy(Z)},this.setScissor=function(e,t,r,i){e.isVector4?Z.set(e.x,e.y,e.z,e.w):Z.set(e,t,r,i),g.scissor(H.copy(Z).multiplyScalar(q).floor())},this.getScissorTest=function(){return $},this.setScissorTest=function(e){g.setScissorTest($=e)},this.setOpaqueSort=function(e){K=e},this.setTransparentSort=function(e){J=e},this.getClearColor=function(){return S.getClearColor()},this.setClearColor=function(){S.setClearColor.apply(S,arguments)},this.getClearAlpha=function(){return S.getClearAlpha()},this.setClearAlpha=function(){S.setClearAlpha.apply(S,arguments)},this.clear=function(e,t,r){var i=0;(void 0===e||e)&&(i|=m.COLOR_BUFFER_BIT),(void 0===t||t)&&(i|=m.DEPTH_BUFFER_BIT),(void 0===r||r)&&(i|=m.STENCIL_BUFFER_BIT),m.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",fe,!1),t.removeEventListener("webglcontextrestored",pe,!1),T.dispose(),E.dispose(),v.dispose(),x.dispose(),ue.dispose(),be.stop()},this.renderBufferImmediate=function(e,t){g.initAttributes();var r=v.get(e);e.hasPositions&&!r.position&&(r.position=m.createBuffer()),e.hasNormals&&!r.normal&&(r.normal=m.createBuffer()),e.hasUvs&&!r.uv&&(r.uv=m.createBuffer()),e.hasColors&&!r.color&&(r.color=m.createBuffer());var i=t.getAttributes();e.hasPositions&&(m.bindBuffer(m.ARRAY_BUFFER,r.position),m.bufferData(m.ARRAY_BUFFER,e.positionArray,m.DYNAMIC_DRAW),g.enableAttribute(i.position),m.vertexAttribPointer(i.position,3,m.FLOAT,!1,0,0)),e.hasNormals&&(m.bindBuffer(m.ARRAY_BUFFER,r.normal),m.bufferData(m.ARRAY_BUFFER,e.normalArray,m.DYNAMIC_DRAW),g.enableAttribute(i.normal),m.vertexAttribPointer(i.normal,3,m.FLOAT,!1,0,0)),e.hasUvs&&(m.bindBuffer(m.ARRAY_BUFFER,r.uv),m.bufferData(m.ARRAY_BUFFER,e.uvArray,m.DYNAMIC_DRAW),g.enableAttribute(i.uv),m.vertexAttribPointer(i.uv,2,m.FLOAT,!1,0,0)),e.hasColors&&(m.bindBuffer(m.ARRAY_BUFFER,r.color),m.bufferData(m.ARRAY_BUFFER,e.colorArray,m.DYNAMIC_DRAW),g.enableAttribute(i.color),m.vertexAttribPointer(i.color,3,m.FLOAT,!1,0,0)),g.disableUnusedAttributes(),m.drawArrays(m.TRIANGLES,0,e.count),e.count=0};var ce=new Scene;this.renderBufferDirect=function(e,t,r,i,a,n){null===t&&(t=ce);var o=a.isMesh&&a.matrixWorld.determinant()<0,s=we(e,t,i,a);g.setMaterial(i,o);var l=!1;j.geometry===r.id&&j.program===s.id&&j.wireframe===(!0===i.wireframe)||(j.geometry=r.id,j.program=s.id,j.wireframe=!0===i.wireframe,l=!0),(i.morphTargets||i.morphNormals)&&(W.update(a,r,i,s),l=!0),!0===a.isInstancedMesh&&(l=!0);var u=r.index,d=r.attributes.position;if(null===u){if(void 0===d||0===d.count)return}else if(0===u.count)return;var f,p=1;!0===i.wireframe&&(u=w.getWireframeAttribute(r),p=2);var b=_;null!==u&&(f=L.get(u),(b=G).setIndex(f)),l&&(!function(e,t,r,i){if(!1===c.isWebGL2&&(e.isInstancedMesh||t.isInstancedBufferGeometry)&&null===h.get("ANGLE_instanced_arrays"))return;g.initAttributes();var a=t.attributes,n=i.getAttributes(),o=r.defaultAttributeValues;for(var s in n){var l=n[s];if(l>=0){var u=a[s];if(void 0!==u){var d=u.normalized,f=u.itemSize,p=L.get(u);if(void 0===p)continue;var b=p.buffer,v=p.type,M=p.bytesPerElement;if(u.isInterleavedBufferAttribute){var w=u.data,x=w.stride,R=u.offset;w&&w.isInstancedInterleavedBuffer?(g.enableAttributeAndDivisor(l,w.meshPerAttribute),void 0===t._maxInstanceCount&&(t._maxInstanceCount=w.meshPerAttribute*w.count)):g.enableAttribute(l),m.bindBuffer(m.ARRAY_BUFFER,b),g.vertexAttribPointer(l,f,v,d,x*M,R*M)}else u.isInstancedBufferAttribute?(g.enableAttributeAndDivisor(l,u.meshPerAttribute),void 0===t._maxInstanceCount&&(t._maxInstanceCount=u.meshPerAttribute*u.count)):g.enableAttribute(l),m.bindBuffer(m.ARRAY_BUFFER,b),g.vertexAttribPointer(l,f,v,d,0,0)}else if("instanceMatrix"===s){var p=L.get(e.instanceMatrix);if(void 0===p)continue;var b=p.buffer,v=p.type;g.enableAttributeAndDivisor(l+0,1),g.enableAttributeAndDivisor(l+1,1),g.enableAttributeAndDivisor(l+2,1),g.enableAttributeAndDivisor(l+3,1),m.bindBuffer(m.ARRAY_BUFFER,b),m.vertexAttribPointer(l+0,4,v,!1,64,0),m.vertexAttribPointer(l+1,4,v,!1,64,16),m.vertexAttribPointer(l+2,4,v,!1,64,32),m.vertexAttribPointer(l+3,4,v,!1,64,48)}else if(void 0!==o){var A=o[s];if(void 0!==A)switch(A.length){case 2:m.vertexAttrib2fv(l,A);break;case 3:m.vertexAttrib3fv(l,A);break;case 4:m.vertexAttrib4fv(l,A);break;default:m.vertexAttrib1fv(l,A)}}}}g.disableUnusedAttributes()}(a,r,i,s),null!==u&&m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,f.buffer));var v=null!==u?u.count:d.count,M=r.drawRange.start*p,x=r.drawRange.count*p,R=null!==n?n.start*p:0,A=null!==n?n.count*p:1/0,T=Math.max(M,R),E=Math.min(v,M+x,R+A)-1,S=Math.max(0,E-T+1);if(0!==S){if(a.isMesh)!0===i.wireframe?(g.setLineWidth(i.wireframeLinewidth*oe()),b.setMode(m.LINES)):b.setMode(m.TRIANGLES);else if(a.isLine){var y=i.linewidth;void 0===y&&(y=1),g.setLineWidth(y*oe()),a.isLineSegments?b.setMode(m.LINES):a.isLineLoop?b.setMode(m.LINE_LOOP):b.setMode(m.LINE_STRIP)}else a.isPoints?b.setMode(m.POINTS):a.isSprite&&b.setMode(m.TRIANGLES);if(a.isInstancedMesh)b.renderInstances(r,T,S,a.count);else if(r.isInstancedBufferGeometry){var F=Math.min(r.instanceCount,r._maxInstanceCount);b.renderInstances(r,T,S,F)}else b.render(T,S)}},this.compile=function(e,t){(p=E.get(e,t)).init(),e.traverse(function(e){e.isLight&&(p.pushLight(e),e.castShadow&&p.pushShadow(e))}),p.setupLights(t);const r={};e.traverse(function(t){let i=t.material;if(i)if(Array.isArray(i))for(let a=0;a<i.length;a++){let n=i[a];n.uuid in r==!1&&(Le(n,e,t),r[n.uuid]=!0)}else i.uuid in r==!1&&(Le(i,e,t),r[i.uuid]=!0)})};var ge=null;var be=new WebGLAnimation;function ve(e,t,r,i){for(var a=0,n=e.length;a<n;a++){var o=e[a],s=o.object,l=o.geometry,u=void 0===i?o.material:i,d=o.group;if(r.isArrayCamera){N=r;for(var f=r.cameras,m=0,h=f.length;m<h;m++){var c=f[m];s.layers.test(c.layers)&&(g.viewport(z.copy(c.viewport)),p.setupLights(c),Me(s,t,c,l,u,d))}}else N=null,Me(s,t,r,l,u,d)}}function Me(e,t,r,i,a,n){if(e.onBeforeRender(F,t,r,i,a,n),p=E.get(t,N||r),e.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject){var o=we(r,t,a,e);g.setMaterial(a),j.geometry=null,j.program=null,j.wireframe=!1,function(e,t){e.render(function(e){F.renderBufferImmediate(e,t)})}(e,o)}else F.renderBufferDirect(r,t,i,a,e,n);e.onAfterRender(F,t,r,i,a,n),p=E.get(t,N||r)}function Le(e,t,r){var i=v.get(e),a=p.state.lights,n=p.state.shadowsArray,o=a.state.version,s=R.getParameters(e,a.state,n,t,te.numPlanes,te.numIntersection,r),l=R.getProgramCacheKey(s),u=i.program,d=!0;if(void 0===u)e.addEventListener("dispose",me);else if(u.cacheKey!==l)he(e);else if(i.lightsStateVersion!==o)i.lightsStateVersion=o,d=!1;else{if(void 0!==s.shaderID)return;d=!1}d&&(u=R.acquireProgram(s,l),i.program=u,i.uniforms=s.uniforms,i.outputEncoding=s.outputEncoding,e.program=u);var f=u.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(var m=0;m<F.maxMorphTargets;m++)f["morphTarget"+m]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals){e.numSupportedMorphNormals=0;for(m=0;m<F.maxMorphNormals;m++)f["morphNormal"+m]>=0&&e.numSupportedMorphNormals++}var h=i.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(i.numClippingPlanes=te.numPlanes,i.numIntersection=te.numIntersection,h.clippingPlanes=te.uniform),i.environment=e.isMeshStandardMaterial?t.environment:null,i.fog=t.fog,i.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),i.lightsStateVersion=o,i.needsLights&&(h.ambientLightColor.value=a.state.ambient,h.lightProbe.value=a.state.probe,h.directionalLights.value=a.state.directional,h.directionalLightShadows.value=a.state.directionalShadow,h.spotLights.value=a.state.spot,h.spotLightShadows.value=a.state.spotShadow,h.rectAreaLights.value=a.state.rectArea,h.pointLights.value=a.state.point,h.pointLightShadows.value=a.state.pointShadow,h.hemisphereLights.value=a.state.hemi,h.directionalShadowMap.value=a.state.directionalShadowMap,h.directionalShadowMatrix.value=a.state.directionalShadowMatrix,h.spotShadowMap.value=a.state.spotShadowMap,h.spotShadowMatrix.value=a.state.spotShadowMatrix,h.pointShadowMap.value=a.state.pointShadowMap,h.pointShadowMatrix.value=a.state.pointShadowMatrix);var c=i.program.getUniforms(),g=WebGLUniforms.seqWithValue(c.seq,h);i.uniformsList=g}function we(e,t,r,i){M.resetTextureUnits();var a=t.fog,n=r.isMeshStandardMaterial?t.environment:null,o=null===I?F.outputEncoding:I.texture.encoding,s=v.get(r),l=p.state.lights;if(re&&(ie||e!==O)){var u=e===O&&r.id===V;te.setState(r.clippingPlanes,r.clipIntersection,r.clipShadows,e,s,u)}r.version===s.__version?void 0===s.program?Le(r,t,i):r.fog&&s.fog!==a?Le(r,t,i):s.environment!==n?Le(r,t,i):s.needsLights&&s.lightsStateVersion!==l.state.version?Le(r,t,i):void 0===s.numClippingPlanes||s.numClippingPlanes===te.numPlanes&&s.numIntersection===te.numIntersection?s.outputEncoding!==o&&Le(r,t,i):Le(r,t,i):(Le(r,t,i),s.__version=r.version);var d,f,h=!1,b=!1,L=!1,w=s.program,x=w.getUniforms(),R=s.uniforms;if(g.useProgram(w.program)&&(h=!0,b=!0,L=!0),r.id!==V&&(V=r.id,b=!0),h||O!==e){if(x.setValue(m,"projectionMatrix",e.projectionMatrix),c.logarithmicDepthBuffer&&x.setValue(m,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),O!==e&&(O=e,b=!0,L=!0),r.isShaderMaterial||r.isMeshPhongMaterial||r.isMeshToonMaterial||r.isMeshStandardMaterial||r.envMap){var T=x.map.cameraPosition;void 0!==T&&T.setValue(m,ne.setFromMatrixPosition(e.matrixWorld))}(r.isMeshPhongMaterial||r.isMeshToonMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial)&&x.setValue(m,"isOrthographic",!0===e.isOrthographicCamera),(r.isMeshPhongMaterial||r.isMeshToonMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial||r.skinning)&&x.setValue(m,"viewMatrix",e.matrixWorldInverse)}if(r.skinning){x.setOptional(m,i,"bindMatrix"),x.setOptional(m,i,"bindMatrixInverse");var E=i.skeleton;if(E){var S=E.bones;if(c.floatVertexTextures){if(void 0===E.boneTexture){var W=Math.sqrt(4*S.length);W=MathUtils.ceilPowerOfTwo(W),W=Math.max(W,4);var _=new Float32Array(W*W*4);_.set(E.boneMatrices);var G=new DataTexture(_,W,W,RGBAFormat,FloatType);E.boneMatrices=_,E.boneTexture=G,E.boneTextureSize=W}x.setValue(m,"boneTexture",E.boneTexture,M),x.setValue(m,"boneTextureSize",E.boneTextureSize)}else x.setOptional(m,E,"boneMatrices")}}return(b||s.receiveShadow!==i.receiveShadow)&&(s.receiveShadow=i.receiveShadow,x.setValue(m,"receiveShadow",i.receiveShadow)),b&&(x.setValue(m,"toneMappingExposure",F.toneMappingExposure),x.setValue(m,"toneMappingWhitePoint",F.toneMappingWhitePoint),s.needsLights&&(f=L,(d=R).ambientLightColor.needsUpdate=f,d.lightProbe.needsUpdate=f,d.directionalLights.needsUpdate=f,d.directionalLightShadows.needsUpdate=f,d.pointLights.needsUpdate=f,d.pointLightShadows.needsUpdate=f,d.spotLights.needsUpdate=f,d.spotLightShadows.needsUpdate=f,d.rectAreaLights.needsUpdate=f,d.hemisphereLights.needsUpdate=f),a&&r.fog&&A.refreshFogUniforms(R,a),A.refreshMaterialUniforms(R,r,n,q,X),void 0!==R.ltc_1&&(R.ltc_1.value=UniformsLib.LTC_1),void 0!==R.ltc_2&&(R.ltc_2.value=UniformsLib.LTC_2),WebGLUniforms.upload(m,s.uniformsList,R,M)),r.isShaderMaterial&&!0===r.uniformsNeedUpdate&&(WebGLUniforms.upload(m,s.uniformsList,R,M),r.uniformsNeedUpdate=!1),r.isSpriteMaterial&&x.setValue(m,"center",i.center),x.setValue(m,"modelViewMatrix",i.modelViewMatrix),x.setValue(m,"normalMatrix",i.normalMatrix),x.setValue(m,"modelMatrix",i.matrixWorld),w}be.setAnimationLoop(function(e){ue.isPresenting||ge&&ge(e)}),"undefined"!=typeof window&&be.setContext(window),this.setAnimationLoop=function(e){ge=e,ue.setAnimationLoop(e),be.start()},this.render=function(e,t){var r,i;if(void 0!==arguments[2]&&(console.warn("THREE.WebGLRenderer.render(): the renderTarget argument has been removed. Use .setRenderTarget() instead."),r=arguments[2]),void 0!==arguments[3]&&(console.warn("THREE.WebGLRenderer.render(): the forceClear argument has been removed. Use .clear() instead."),i=arguments[3]),t&&t.isCamera){if(!P){j.geometry=null,j.program=null,j.wireframe=!1,V=-1,O=null,!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),ue.enabled&&ue.isPresenting&&(t=ue.getCamera(t)),e.onBeforeRender(F,e,t,r||I),(p=E.get(e,t)).init(),ae.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),ee.setFromProjectionMatrix(ae),ie=this.localClippingEnabled,re=te.init(this.clippingPlanes,ie,t),(f=T.get(e,t)).init(),function e(t,r,i,a){if(!1===t.visible)return;var n=t.layers.test(r.layers);if(n)if(t.isGroup)i=t.renderOrder;else if(t.isLOD)!0===t.autoUpdate&&t.update(r);else if(t.isLight)p.pushLight(t),t.castShadow&&p.pushShadow(t);else if(t.isSprite){if(!t.frustumCulled||ee.intersectsSprite(t)){a&&ne.setFromMatrixPosition(t.matrixWorld).applyMatrix4(ae);var o=x.update(t),s=t.material;s.visible&&f.push(t,o,s,i,ne.z,null)}}else if(t.isImmediateRenderObject)a&&ne.setFromMatrixPosition(t.matrixWorld).applyMatrix4(ae),f.push(t,null,t.material,i,ne.z,null);else if((t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.frame!==b.render.frame&&(t.skeleton.update(),t.skeleton.frame=b.render.frame),!t.frustumCulled||ee.intersectsObject(t))){a&&ne.setFromMatrixPosition(t.matrixWorld).applyMatrix4(ae);var o=x.update(t),s=t.material;if(Array.isArray(s))for(var l=o.groups,u=0,d=l.length;u<d;u++){var m=l[u],h=s[m.materialIndex];h&&h.visible&&f.push(t,o,h,i,ne.z,m)}else s.visible&&f.push(t,o,s,i,ne.z,null)}var c=t.children;for(var u=0,d=c.length;u<d;u++)e(c[u],r,i,a)}(e,t,0,F.sortObjects),f.finish(),!0===F.sortObjects&&f.sort(K,J),re&&te.beginShadows();var a=p.state.shadowsArray;de.render(a,e,t),p.setupLights(t),re&&te.endShadows(),this.info.autoReset&&this.info.reset(),void 0!==r&&this.setRenderTarget(r),S.render(f,e,t,i);var n=f.opaque,o=f.transparent;if(e.overrideMaterial){var s=e.overrideMaterial;n.length&&ve(n,e,t,s),o.length&&ve(o,e,t,s)}else n.length&&ve(n,e,t),o.length&&ve(o,e,t);e.onAfterRender(F,e,t),null!==I&&(M.updateRenderTargetMipmap(I),M.updateMultisampleRenderTarget(I)),g.buffers.depth.setTest(!0),g.buffers.depth.setMask(!0),g.buffers.color.setMask(!0),g.setPolygonOffset(!1),f=null,p=null}}else console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.setFramebuffer=function(e){C!==e&&null===I&&m.bindFramebuffer(m.FRAMEBUFFER,e),C=e},this.getActiveCubeFace=function(){return B},this.getActiveMipmapLevel=function(){return U},this.getRenderTarget=function(){return I},this.setRenderTarget=function(e,t,r){I=e,B=t,U=r,e&&void 0===v.get(e).__webglFramebuffer&&M.setupRenderTarget(e);var i=C,a=!1;if(e){var n=v.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(i=n[t||0],a=!0):i=e.isWebGLMultisampleRenderTarget?v.get(e).__webglMultisampledFramebuffer:n,z.copy(e.viewport),H.copy(e.scissor),k=e.scissorTest}else z.copy(Q).multiplyScalar(q).floor(),H.copy(Z).multiplyScalar(q).floor(),k=$;if(D!==i&&(m.bindFramebuffer(m.FRAMEBUFFER,i),D=i),g.viewport(z),g.scissor(H),g.setScissorTest(k),a){var o=v.get(e.texture);m.framebufferTexture2D(m.FRAMEBUFFER,m.COLOR_ATTACHMENT0,m.TEXTURE_CUBE_MAP_POSITIVE_X+(t||0),o.__webglTexture,r||0)}},this.readRenderTargetPixels=function(e,t,r,i,a,n,o){if(e&&e.isWebGLRenderTarget){var s=v.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==o&&(s=s[o]),s){var l=!1;s!==D&&(m.bindFramebuffer(m.FRAMEBUFFER,s),l=!0);try{var u=e.texture,d=u.format,f=u.type;if(d!==RGBAFormat&&y.convert(d)!==m.getParameter(m.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(f===UnsignedByteType||y.convert(f)===m.getParameter(m.IMPLEMENTATION_COLOR_READ_TYPE)||f===FloatType&&(c.isWebGL2||h.get("OES_texture_float")||h.get("WEBGL_color_buffer_float"))||f===HalfFloatType&&(c.isWebGL2?h.get("EXT_color_buffer_float"):h.get("EXT_color_buffer_half_float"))))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");m.checkFramebufferStatus(m.FRAMEBUFFER)===m.FRAMEBUFFER_COMPLETE?t>=0&&t<=e.width-i&&r>=0&&r<=e.height-a&&m.readPixels(t,r,i,a,y.convert(d),y.convert(f),n):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{l&&m.bindFramebuffer(m.FRAMEBUFFER,D)}}}else console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.")},this.copyFramebufferToTexture=function(e,t,r){void 0===r&&(r=0);var i=Math.pow(2,-r),a=Math.floor(t.image.width*i),n=Math.floor(t.image.height*i),o=y.convert(t.format);M.setTexture2D(t,0),m.copyTexImage2D(m.TEXTURE_2D,r,o,e.x,e.y,a,n,0),g.unbindTexture()},this.copyTextureToTexture=function(e,t,r,i){void 0===i&&(i=0);var a=t.image.width,n=t.image.height,o=y.convert(r.format),s=y.convert(r.type);M.setTexture2D(r,0),t.isDataTexture?m.texSubImage2D(m.TEXTURE_2D,i,e.x,e.y,a,n,o,s,t.image.data):t.isCompressedTexture?m.compressedTexSubImage2D(m.TEXTURE_2D,i,e.x,e.y,t.mipmaps[0].width,t.mipmaps[0].height,o,t.mipmaps[0].data):m.texSubImage2D(m.TEXTURE_2D,i,e.x,e.y,o,s,t.image),0===i&&r.generateMipmaps&&m.generateMipmap(m.TEXTURE_2D),g.unbindTexture()},this.initTexture=function(e){M.setTexture2D(e,0),g.unbindTexture()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}export{WebGLRenderer};
//# sourceMappingURL=/sm/673eb80c800f23d91a5d5d04b13622b4be528ccde26077087d4eb668bcda3b5b.map