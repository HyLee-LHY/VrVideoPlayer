/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/three@0.117.1/src/renderers/webxr/WebXRManager.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{ArrayCamera}from"../../cameras/ArrayCamera.js";import{EventDispatcher}from"../../core/EventDispatcher.js";import{PerspectiveCamera}from"../../cameras/PerspectiveCamera.js";import{Vector3}from"../../math/Vector3.js";import{Vector4}from"../../math/Vector4.js";import{WebGLAnimation}from"../webgl/WebGLAnimation.js";import{WebXRController}from"./WebXRController.js";function WebXRManager(e,t){var r=this,a=null,n=1,i=null,o="local-floor",s=null,c=[],l=new Map,p=new PerspectiveCamera;p.layers.enable(1),p.viewport=new Vector4;var m=new PerspectiveCamera;m.layers.enable(2),m.viewport=new Vector4;var d=[p,m],f=new ArrayCamera;f.layers.enable(1),f.layers.enable(2);var u=null,v=null;function h(e){var t=l.get(e.inputSource);t&&t.dispatchEvent({type:e.type})}function g(){l.forEach(function(e,t){e.disconnect(t)}),l.clear(),e.setFramebuffer(null),e.setRenderTarget(e.getRenderTarget()),R.stop(),r.isPresenting=!1,r.dispatchEvent({type:"sessionend"})}function x(e){i=e,R.setContext(a),R.start(),r.isPresenting=!0,r.dispatchEvent({type:"sessionstart"})}function b(e){for(var t=a.inputSources,r=0;r<c.length;r++)l.set(t[r],c[r]);for(r=0;r<e.removed.length;r++){var n=e.removed[r];(i=l.get(n))&&(i.dispatchEvent({type:"disconnected",data:n}),l.delete(n))}for(r=0;r<e.added.length;r++){var i;n=e.added[r];(i=l.get(n))&&i.dispatchEvent({type:"connected",data:n})}}this.enabled=!1,this.isPresenting=!1,this.getController=function(e){var t=c[e];return void 0===t&&(t=new WebXRController,c[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){var t=c[e];return void 0===t&&(t=new WebXRController,c[e]=t),t.getGripSpace()},this.setFramebufferScaleFactor=function(e){n=e,!0===r.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){o=e,!0===r.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return i},this.getSession=function(){return a},this.setSession=function(e){if(null!==(a=e)){a.addEventListener("select",h),a.addEventListener("selectstart",h),a.addEventListener("selectend",h),a.addEventListener("squeeze",h),a.addEventListener("squeezestart",h),a.addEventListener("squeezeend",h),a.addEventListener("end",g);var r=t.getContextAttributes();!0!==r.xrCompatible&&t.makeXRCompatible();var i={antialias:r.antialias,alpha:r.alpha,depth:r.depth,stencil:r.stencil,framebufferScaleFactor:n},s=new XRWebGLLayer(a,t,i);a.updateRenderState({baseLayer:s}),a.requestReferenceSpace(o).then(x),a.addEventListener("inputsourceschange",b)}};var y=new Vector3,W=new Vector3;function w(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.getInverse(e.matrixWorld)}this.getCamera=function(e){f.near=m.near=p.near=e.near,f.far=m.far=p.far=e.far,u===f.near&&v===f.far||(a.updateRenderState({depthNear:f.near,depthFar:f.far}),u=f.near,v=f.far);var t=e.parent,r=f.cameras;w(f,t);for(var n=0;n<r.length;n++)w(r[n],t);e.matrixWorld.copy(f.matrixWorld);for(var i=e.children,o=(n=0,i.length);n<o;n++)i[n].updateMatrixWorld(!0);return 2===r.length?function(e,t,r){y.setFromMatrixPosition(t.matrixWorld),W.setFromMatrixPosition(r.matrixWorld);var a=y.distanceTo(W),n=t.projectionMatrix.elements,i=r.projectionMatrix.elements,o=n[14]/(n[10]-1),s=n[14]/(n[10]+1),c=(n[9]+1)/n[5],l=(n[9]-1)/n[5],p=(n[8]-1)/n[0],m=(i[8]+1)/i[0],d=o*p,f=o*m,u=a/(-p+m),v=u*-p;t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(v),e.translateZ(u),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.getInverse(e.matrixWorld);var h=o+u,g=s+u,x=d-v,b=f+(a-v),w=c*s/g*h,E=l*s/g*h;e.projectionMatrix.makePerspective(x,b,w,E,h,g)}(f,p,m):f.projectionMatrix.copy(p.projectionMatrix),f};var E=null;var R=new WebGLAnimation;R.setAnimationLoop(function(t,r){if(null!==(s=r.getViewerPose(i))){var n=s.views,o=a.renderState.baseLayer;e.setFramebuffer(o.framebuffer);var l=!1;n.length!==f.cameras.length&&(f.cameras.length=0,l=!0);for(var p=0;p<n.length;p++){var m=n[p],u=o.getViewport(m),v=d[p];v.matrix.fromArray(m.transform.matrix),v.projectionMatrix.fromArray(m.projectionMatrix),v.viewport.set(u.x,u.y,u.width,u.height),0===p&&f.matrix.copy(v.matrix),!0===l&&f.cameras.push(v)}}var h=a.inputSources;for(p=0;p<c.length;p++){var g=c[p],x=h[p];g.update(x,r,i)}E&&E(t,r)}),this.setAnimationLoop=function(e){E=e},this.dispose=function(){}}Object.assign(WebXRManager.prototype,EventDispatcher.prototype);export{WebXRManager};
//# sourceMappingURL=/sm/8a26068be653e6953a0abd2b585470cb68b42db937146e6ec768fdd6389aa202.map