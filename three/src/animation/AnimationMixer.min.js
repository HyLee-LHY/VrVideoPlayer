/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/three@0.117.1/src/animation/AnimationMixer.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{AnimationAction}from"./AnimationAction.js";import{EventDispatcher}from"../core/EventDispatcher.js";import{LinearInterpolant}from"../math/interpolants/LinearInterpolant.js";import{PropertyBinding}from"./PropertyBinding.js";import{PropertyMixer}from"./PropertyMixer.js";import{AnimationClip}from"./AnimationClip.js";import{NormalAnimationBlendMode}from"../constants.js";function AnimationMixer(n){this._root=n,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}AnimationMixer.prototype=Object.assign(Object.create(EventDispatcher.prototype),{constructor:AnimationMixer,_bindAction:function(n,t){var i=n._localRoot||this._root,e=n._clip.tracks,o=e.length,c=n._propertyBindings,a=n._interpolants,r=i.uuid,s=this._bindingsByRootAndName,h=s[r];void 0===h&&(h={},s[r]=h);for(var _=0;_!==o;++_){var d=e[_],l=d.name,u=h[l];if(void 0!==u)c[_]=u;else{if(void 0!==(u=c[_])){null===u._cacheIndex&&(++u.referenceCount,this._addInactiveBinding(u,r,l));continue}var v=t&&t._propertyBindings[_].binding.parsedPath;++(u=new PropertyMixer(PropertyBinding.create(i,l,v),d.ValueTypeName,d.getValueSize())).referenceCount,this._addInactiveBinding(u,r,l),c[_]=u}a[_].resultBuffer=u.buffer}},_activateAction:function(n){if(!this._isActiveAction(n)){if(null===n._cacheIndex){var t=(n._localRoot||this._root).uuid,i=n._clip.uuid,e=this._actionsByClip[i];this._bindAction(n,e&&e.knownActions[0]),this._addInactiveAction(n,i,t)}for(var o=n._propertyBindings,c=0,a=o.length;c!==a;++c){var r=o[c];0==r.useCount++&&(this._lendBinding(r),r.saveOriginalState())}this._lendAction(n)}},_deactivateAction:function(n){if(this._isActiveAction(n)){for(var t=n._propertyBindings,i=0,e=t.length;i!==e;++i){var o=t[i];0==--o.useCount&&(o.restoreOriginalState(),this._takeBackBinding(o))}this._takeBackAction(n)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var n=this;this.stats={actions:{get total(){return n._actions.length},get inUse(){return n._nActiveActions}},bindings:{get total(){return n._bindings.length},get inUse(){return n._nActiveBindings}},controlInterpolants:{get total(){return n._controlInterpolants.length},get inUse(){return n._nActiveControlInterpolants}}}},_isActiveAction:function(n){var t=n._cacheIndex;return null!==t&&t<this._nActiveActions},_addInactiveAction:function(n,t,i){var e=this._actions,o=this._actionsByClip,c=o[t];if(void 0===c)c={knownActions:[n],actionByRoot:{}},n._byClipCacheIndex=0,o[t]=c;else{var a=c.knownActions;n._byClipCacheIndex=a.length,a.push(n)}n._cacheIndex=e.length,e.push(n),c.actionByRoot[i]=n},_removeInactiveAction:function(n){var t=this._actions,i=t[t.length-1],e=n._cacheIndex;i._cacheIndex=e,t[e]=i,t.pop(),n._cacheIndex=null;var o=n._clip.uuid,c=this._actionsByClip,a=c[o],r=a.knownActions,s=r[r.length-1],h=n._byClipCacheIndex;s._byClipCacheIndex=h,r[h]=s,r.pop(),n._byClipCacheIndex=null,delete a.actionByRoot[(n._localRoot||this._root).uuid],0===r.length&&delete c[o],this._removeInactiveBindingsForAction(n)},_removeInactiveBindingsForAction:function(n){for(var t=n._propertyBindings,i=0,e=t.length;i!==e;++i){var o=t[i];0==--o.referenceCount&&this._removeInactiveBinding(o)}},_lendAction:function(n){var t=this._actions,i=n._cacheIndex,e=this._nActiveActions++,o=t[e];n._cacheIndex=e,t[e]=n,o._cacheIndex=i,t[i]=o},_takeBackAction:function(n){var t=this._actions,i=n._cacheIndex,e=--this._nActiveActions,o=t[e];n._cacheIndex=e,t[e]=n,o._cacheIndex=i,t[i]=o},_addInactiveBinding:function(n,t,i){var e=this._bindingsByRootAndName,o=e[t],c=this._bindings;void 0===o&&(o={},e[t]=o),o[i]=n,n._cacheIndex=c.length,c.push(n)},_removeInactiveBinding:function(n){var t=this._bindings,i=n.binding,e=i.rootNode.uuid,o=i.path,c=this._bindingsByRootAndName,a=c[e],r=t[t.length-1],s=n._cacheIndex;r._cacheIndex=s,t[s]=r,t.pop(),delete a[o],0===Object.keys(a).length&&delete c[e]},_lendBinding:function(n){var t=this._bindings,i=n._cacheIndex,e=this._nActiveBindings++,o=t[e];n._cacheIndex=e,t[e]=n,o._cacheIndex=i,t[i]=o},_takeBackBinding:function(n){var t=this._bindings,i=n._cacheIndex,e=--this._nActiveBindings,o=t[e];n._cacheIndex=e,t[e]=n,o._cacheIndex=i,t[i]=o},_lendControlInterpolant:function(){var n=this._controlInterpolants,t=this._nActiveControlInterpolants++,i=n[t];return void 0===i&&((i=new LinearInterpolant(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer)).__cacheIndex=t,n[t]=i),i},_takeBackControlInterpolant:function(n){var t=this._controlInterpolants,i=n.__cacheIndex,e=--this._nActiveControlInterpolants,o=t[e];n.__cacheIndex=e,t[e]=n,o.__cacheIndex=i,t[i]=o},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(n,t,i){var e=t||this._root,o=e.uuid,c="string"==typeof n?AnimationClip.findByName(e,n):n,a=null!==c?c.uuid:n,r=this._actionsByClip[a],s=null;if(void 0===i&&(i=null!==c?c.blendMode:NormalAnimationBlendMode),void 0!==r){var h=r.actionByRoot[o];if(void 0!==h&&h.blendMode===i)return h;s=r.knownActions[0],null===c&&(c=s._clip)}if(null===c)return null;var _=new AnimationAction(this,c,t,i);return this._bindAction(_,s),this._addInactiveAction(_,a,o),_},existingAction:function(n,t){var i=t||this._root,e=i.uuid,o="string"==typeof n?AnimationClip.findByName(i,n):n,c=o?o.uuid:n,a=this._actionsByClip[c];return void 0!==a&&a.actionByRoot[e]||null},stopAllAction:function(){for(var n=this._actions,t=this._nActiveActions-1;t>=0;--t)n[t].stop();return this},update:function(n){n*=this.timeScale;for(var t=this._actions,i=this._nActiveActions,e=this.time+=n,o=Math.sign(n),c=this._accuIndex^=1,a=0;a!==i;++a){t[a]._update(e,n,o,c)}var r=this._bindings,s=this._nActiveBindings;for(a=0;a!==s;++a)r[a].apply(c);return this},setTime:function(n){this.time=0;for(var t=0;t<this._actions.length;t++)this._actions[t].time=0;return this.update(n)},getRoot:function(){return this._root},uncacheClip:function(n){var t=this._actions,i=n.uuid,e=this._actionsByClip,o=e[i];if(void 0!==o){for(var c=o.knownActions,a=0,r=c.length;a!==r;++a){var s=c[a];this._deactivateAction(s);var h=s._cacheIndex,_=t[t.length-1];s._cacheIndex=null,s._byClipCacheIndex=null,_._cacheIndex=h,t[h]=_,t.pop(),this._removeInactiveBindingsForAction(s)}delete e[i]}},uncacheRoot:function(n){var t=n.uuid,i=this._actionsByClip;for(var e in i){var o=i[e].actionByRoot[t];void 0!==o&&(this._deactivateAction(o),this._removeInactiveAction(o))}var c=this._bindingsByRootAndName[t];if(void 0!==c)for(var a in c){var r=c[a];r.restoreOriginalState(),this._removeInactiveBinding(r)}},uncacheAction:function(n,t){var i=this.existingAction(n,t);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}});export{AnimationMixer};
//# sourceMappingURL=/sm/b79abfc08037e0003bd4708eb9a1bd81b53c88059a8d1add152dd3e436feea6e.map